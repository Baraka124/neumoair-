<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1E6EA6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Lung transplant calculation assistant with patient timeline tracking">
    
    <title>NeumoCalc | Patient Timeline Calculator</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    
    <style>
        /* ===== RESET & BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc; color: #1f2937; 
            height: 100vh; overflow: hidden;
        }
        
        /* ===== APP CONTAINER ===== */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* ===== HEADER ===== */
        .app-header {
            background: white; padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between;
            align-items: center;
        }
        
        .patient-header {
            display: flex; gap: 1rem; align-items: center;
        }
        
        .patient-id-display {
            font-family: monospace; font-weight: 700;
            color: #1E6EA6; font-size: 1.2rem;
        }
        
        .timeline-info {
            font-size: 0.875rem; color: #6b7280;
        }
        
        /* ===== MODE SELECTOR ===== */
        .mode-selector {
            display: flex; background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem; gap: 0.5rem;
        }
        
        .mode-btn {
            flex: 1; padding: 0.75rem; border: none;
            border-radius: 10px; background: #f9fafb;
            color: #6b7280; font-weight: 600; cursor: pointer;
        }
        
        .mode-btn.active {
            background: #1E6EA6; color: white;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content { flex: 1; overflow-y: auto; padding: 1rem; }
        
        /* ===== PATIENT SELECTOR (Quick Mode) ===== */
        .patient-selector {
            background: white; border-radius: 12px;
            padding: 1rem; margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .patient-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem; margin-top: 1rem;
        }
        
        .patient-card {
            border: 2px solid #e5e7eb; border-radius: 10px;
            padding: 0.75rem; cursor: pointer; transition: all 0.2s;
        }
        
        .patient-card.active {
            border-color: #1E6EA6; background: #f0f9ff;
        }
        
        .patient-id { font-weight: 600; color: #1E6EA6; }
        .patient-stats { font-size: 0.75rem; color: #6b7280; }
        
        /* ===== QUICK CALC ===== */
        .quick-calc-container {
            background: white; border-radius: 12px;
            padding: 1.5rem; margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .calc-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        .input-group { position: relative; }
        .input-label { font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 0.5rem; }
        
        .calc-input {
            width: 100%; padding: 1rem; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 1.5rem; font-weight: 600;
            font-family: monospace; text-align: center;
        }
        
        .calc-input:focus { outline: none; border-color: #1E6EA6; }
        
        /* ===== FULL PATIENT MODE ===== */
        .full-patient-mode { display: none; }
        
        .patient-profile {
            background: white; border-radius: 12px;
            padding: 1.5rem; margin-bottom: 1rem;
        }
        
        .timeline-inputs {
            display: grid; gap: 1rem; margin-top: 1rem;
        }
        
        .date-input {
            padding: 0.75rem; border: 2px solid #e5e7eb;
            border-radius: 10px; width: 100%;
        }
        
        /* ===== TIMELINE CALCULATIONS ===== */
        .timeline-calculations {
            background: white; border-radius: 12px;
            padding: 1.5rem; margin-top: 1rem;
        }
        
        .timeline-row {
            display: flex; justify-content: space-between;
            padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;
        }
        
        .timeline-label { color: #4b5563; }
        .timeline-value { font-family: monospace; font-weight: 600; }
        
        .value-positive { color: #059669; }
        .value-negative { color: #dc2626; }
        .value-neutral { color: #6b7280; }
        
        /* ===== RESULTS DISPLAY ===== */
        .results-display {
            background: white; border-radius: 12px;
            padding: 1.5rem; margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .measurement-card {
            background: #f8fafc; border-radius: 8px;
            padding: 1rem; margin-bottom: 1rem;
        }
        
        .threshold-info {
            background: #fef3c7; border-radius: 8px;
            padding: 1rem; margin-top: 1rem;
            border-left: 4px solid #f59e0b;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex; gap: 0.75rem; margin-top: 1.5rem;
        }
        
        .btn {
            flex: 1; padding: 1rem; border: none;
            border-radius: 10px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        
        .btn-primary {
            background: #1E6EA6; color: white;
        }
        
        .btn-secondary {
            background: #f3f4f6; color: #4b5563;
            border: 1px solid #d1d5db;
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center;
            z-index: 1000; padding: 1rem;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white; border-radius: 12px;
            padding: 1.5rem; width: 100%; max-width: 400px;
        }
        
        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .calc-inputs { grid-template-columns: 1fr; }
            .patient-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="patient-header">
                <div class="patient-id-display" id="currentPatientId">No Patient Selected</div>
                <div class="timeline-info" id="timelineInfo"></div>
            </div>
            <div>
                <button class="btn-secondary" onclick="showNewPatientModal()">New Patient</button>
            </div>
        </header>
        
        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('quick')">‚ö° Quick Calc</button>
            <button class="mode-btn" onclick="switchMode('full')">üìã Full Patient</button>
            <button class="mode-btn" onclick="switchMode('review')">üìä Review All</button>
        </div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Calc Mode -->
            <div id="modeQuick">
                <div class="patient-selector">
                    <h3>Select Patient</h3>
                    <div class="patient-grid" id="patientGrid">
                        <!-- Patient cards will be inserted here -->
                    </div>
                </div>
                
                <div class="quick-calc-container">
                    <h3>Quick Calculation</h3>
                    <div class="calc-inputs">
                        <div class="input-group">
                            <div class="input-label">FEV‚ÇÅ (L)</div>
                            <input type="number" step="0.01" class="calc-input" 
                                   id="quickFev1" placeholder="2.85" autofocus>
                        </div>
                        <div class="input-group">
                            <div class="input-label">FVC (L)</div>
                            <input type="number" step="0.01" class="calc-input" 
                                   id="quickFvc" placeholder="3.40">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-secondary" onclick="clearQuickInputs()">Clear</button>
                        <button class="btn-primary" onclick="calculateQuick()">Calculate</button>
                    </div>
                </div>
                
                <div class="results-display hidden" id="quickResults">
                    <!-- Results will be inserted here -->
                </div>
            </div>
            
            <!-- Full Patient Mode -->
            <div class="full-patient-mode hidden" id="modeFull">
                <div class="patient-profile">
                    <h3 id="fullPatientName">Patient Profile</h3>
                    <div class="timeline-inputs">
                        <div>
                            <div class="input-label">Transplant Date</div>
                            <input type="date" class="date-input" id="transplantDate">
                        </div>
                        <div>
                            <div class="input-label">Baseline FEV‚ÇÅ (L)</div>
                            <input type="number" step="0.01" class="calc-input" 
                                   id="baselineFev1" placeholder="Best post-transplant value">
                        </div>
                    </div>
                </div>
                
                <div class="timeline-calculations">
                    <h3>Timeline Analysis</h3>
                    <div id="timelineAnalysis">
                        <!-- Timeline data will be inserted here -->
                    </div>
                </div>
                
                <div class="results-display" id="fullResults">
                    <!-- Full results will be inserted here -->
                </div>
            </div>
            
            <!-- Review Mode -->
            <div class="full-patient-mode hidden" id="modeReview">
                <div class="patient-profile">
                    <h3>All Patients Summary</h3>
                    <div id="allPatientsSummary">
                        <!-- Summary will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- New Patient Modal -->
    <div class="modal" id="newPatientModal">
        <div class="modal-content">
            <h3>Create New Patient</h3>
            <div style="margin: 1rem 0;">
                <div class="input-label">Patient ID (PT001, PT002, etc.)</div>
                <input type="text" class="calc-input" id="newPatientId" 
                       placeholder="PT001" style="font-size: 1rem;">
            </div>
            <div style="margin: 1rem 0;">
                <div class="input-label">Transplant Date</div>
                <input type="date" class="date-input" id="newTransplantDate">
            </div>
            <div class="action-buttons">
                <button class="btn-secondary" onclick="hideModal('newPatientModal')">Cancel</button>
                <button class="btn-primary" onclick="createNewPatient()">Create</button>
            </div>
        </div>
    </div>

<script>
// ============================================
// NEUMOCALC TIMELINE CALCULATOR
// ============================================

// App State
const state = {
    mode: 'quick',
    currentPatient: null,
    patients: new Map(), // PT001 ‚Üí patientData
    nextPatientId: 1
};

// DOM Elements
const elements = {};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initializeElements();
    loadFromStorage();
    updatePatientDisplay();
    setTodayDates();
});

function initializeElements() {
    // Mode containers
    elements.modeQuick = document.getElementById('modeQuick');
    elements.modeFull = document.getElementById('modeFull');
    elements.modeReview = document.getElementById('modeReview');
    
    // Quick mode
    elements.quickFev1 = document.getElementById('quickFev1');
    elements.quickFvc = document.getElementById('quickFvc');
    elements.quickResults = document.getElementById('quickResults');
    elements.patientGrid = document.getElementById('patientGrid');
    
    // Full mode
    elements.transplantDate = document.getElementById('transplantDate');
    elements.baselineFev1 = document.getElementById('baselineFev1');
    elements.fullResults = document.getElementById('fullResults');
    elements.timelineAnalysis = document.getElementById('timelineAnalysis');
    
    // Patient info
    elements.currentPatientId = document.getElementById('currentPatientId');
    elements.timelineInfo = document.getElementById('timelineInfo');
    
    // Review mode
    elements.allPatientsSummary = document.getElementById('allPatientsSummary');
    
    // Modals
    elements.newPatientModal = document.getElementById('newPatientModal');
    elements.newPatientId = document.getElementById('newPatientId');
    elements.newTransplantDate = document.getElementById('newTransplantDate');
}

// ===== PATIENT MANAGEMENT =====

function generatePatientId() {
    return `PT${state.nextPatientId.toString().padStart(3, '0')}`;
}

function createNewPatient() {
    const id = elements.newPatientId.value.trim().toUpperCase() || generatePatientId();
    const transplantDate = elements.newTransplantDate.value;
    
    if (!transplantDate) {
        alert('Please enter transplant date');
        return;
    }
    
    // Create patient object
    const patient = {
        id: id,
        transplantDate: transplantDate,
        baselineFev1: null,
        visits: [],
        created: new Date().toISOString()
    };
    
    // Add to state
    state.patients.set(id, patient);
    state.currentPatient = id;
    state.nextPatientId++;
    
    // Update UI
    updatePatientDisplay();
    hideModal('newPatientModal');
    saveToStorage();
    
    // Switch to full mode for setup
    switchMode('full');
}

function selectPatient(patientId) {
    state.currentPatient = patientId;
    updatePatientDisplay();
    
    if (state.mode === 'full') {
        loadPatientData();
    }
}

function updatePatientDisplay() {
    // Update header
    if (state.currentPatient && state.patients.has(state.currentPatient)) {
        const patient = state.patients.get(state.currentPatient);
        elements.currentPatientId.textContent = patient.id;
        
        // Calculate days since transplant
        if (patient.transplantDate) {
            const days = daysBetween(patient.transplantDate, new Date().toISOString().split('T')[0]);
            elements.timelineInfo.textContent = `${days} days post-transplant`;
        }
    } else {
        elements.currentPatientId.textContent = 'No Patient Selected';
        elements.timelineInfo.textContent = '';
    }
    
    // Update patient grid
    updatePatientGrid();
}

function updatePatientGrid() {
    elements.patientGrid.innerHTML = '';
    
    state.patients.forEach((patient, id) => {
        const card = document.createElement('div');
        card.className = `patient-card ${id === state.currentPatient ? 'active' : ''}`;
        card.innerHTML = `
            <div class="patient-id">${patient.id}</div>
            <div class="patient-stats">${patient.visits.length} visits</div>
            <div class="patient-stats">${patient.transplantDate || 'No date'}</div>
        `;
        card.onclick = () => selectPatient(id);
        elements.patientGrid.appendChild(card);
    });
}

// ===== CALCULATION LOGIC =====

function calculateQuick() {
    const fev1 = parseFloat(elements.quickFev1.value);
    const fvc = parseFloat(elements.quickFvc.value);
    
    if (!fev1 || !fvc) {
        alert('Please enter both FEV‚ÇÅ and FVC values');
        return;
    }
    
    if (!state.currentPatient) {
        alert('Please select a patient first');
        return;
    }
    
    const patient = state.patients.get(state.currentPatient);
    const results = calculateAllValues(fev1, fvc, patient);
    
    // Display results
    displayQuickResults(results, patient);
}

function calculateAllValues(fev1, fvc, patient) {
    const ratio = (fev1 / fvc * 100).toFixed(1);
    
    const results = {
        measurements: {
            fev1: fev1.toFixed(2),
            fvc: fvc.toFixed(2),
            ratio: ratio
        }
    };
    
    // Add baseline comparison if available
    if (patient.baselineFev1) {
        const change = ((fev1 - patient.baselineFev1) / patient.baselineFev1 * 100).toFixed(1);
        const absChange = (fev1 - patient.baselineFev1).toFixed(2);
        
        results.baselineComparison = {
            baseline: patient.baselineFev1.toFixed(2),
            absoluteChange: absChange,
            percentChange: change
        };
    }
    
    // Add timeline calculations if transplant date exists
    if (patient.transplantDate) {
        const daysSinceTx = daysBetween(patient.transplantDate, new Date().toISOString().split('T')[0]);
        results.timeline = {
            daysSinceTransplant: daysSinceTx,
            yearsSinceTransplant: (daysSinceTx / 365.25).toFixed(1)
        };
    }
    
    // Add last visit comparison if available
    if (patient.visits.length > 0) {
        const lastVisit = patient.visits[patient.visits.length - 1];
        const daysSinceLast = daysBetween(lastVisit.date, new Date().toISOString().split('T')[0]);
        const changeFromLast = ((fev1 - lastVisit.fev1) / lastVisit.fev1 * 100).toFixed(1);
        const rate = ((fev1 - lastVisit.fev1) / (daysSinceLast / 30.44)).toFixed(3);
        
        results.lastVisitComparison = {
            lastValue: lastVisit.fev1.toFixed(2),
            daysSinceLast: daysSinceLast,
            changeFromLast: changeFromLast,
            ratePerMonth: rate
        };
    }
    
    return results;
}

function displayQuickResults(results, patient) {
    let html = `
        <div class="measurement-card">
            <h4>Current Measurements</h4>
            <div class="timeline-row">
                <span class="timeline-label">FEV‚ÇÅ</span>
                <span class="timeline-value">${results.measurements.fev1} L</span>
            </div>
            <div class="timeline-row">
                <span class="timeline-label">FVC</span>
                <span class="timeline-value">${results.measurements.fvc} L</span>
            </div>
            <div class="timeline-row">
                <span class="timeline-label">FEV‚ÇÅ/FVC</span>
                <span class="timeline-value">${results.measurements.ratio}%</span>
            </div>
        </div>
    `;
    
    // Add baseline comparison
    if (results.baselineComparison) {
        const changeClass = parseFloat(results.baselineComparison.percentChange) < 0 ? 'value-negative' : 'value-positive';
        html += `
            <div class="measurement-card">
                <h4>vs Baseline (${results.baselineComparison.baseline} L)</h4>
                <div class="timeline-row">
                    <span class="timeline-label">Œî FEV‚ÇÅ</span>
                    <span class="timeline-value ${changeClass}">${results.baselineComparison.absoluteChange} L</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">% Change</span>
                    <span class="timeline-value ${changeClass}">${results.baselineComparison.percentChange}%</span>
                </div>
            </div>
        `;
    }
    
    // Add timeline info
    if (results.timeline) {
        html += `
            <div class="measurement-card">
                <h4>Transplant Timeline</h4>
                <div class="timeline-row">
                    <span class="timeline-label">Days post-Tx</span>
                    <span class="timeline-value">${results.timeline.daysSinceTransplant}</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">Years post-Tx</span>
                    <span class="timeline-value">${results.timeline.yearsSinceTransplant}</span>
                </div>
            </div>
        `;
    }
    
    // Add last visit comparison
    if (results.lastVisitComparison) {
        const changeClass = parseFloat(results.lastVisitComparison.changeFromLast) < 0 ? 'value-negative' : 'value-positive';
        html += `
            <div class="measurement-card">
                <h4>vs Last Visit (${results.lastVisitComparison.lastValue} L)</h4>
                <div class="timeline-row">
                    <span class="timeline-label">Days since last</span>
                    <span class="timeline-value">${results.lastVisitComparison.daysSinceLast}</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">% Change</span>
                    <span class="timeline-value ${changeClass}">${results.lastVisitComparison.changeFromLast}%</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">Rate of change</span>
                    <span class="timeline-value ${changeClass}">${results.lastVisitComparison.ratePerMonth} L/month</span>
                </div>
            </div>
        `;
    }
    
    // Add threshold reference (NOT diagnosis)
    html += `
        <div class="threshold-info">
            <h4>ISHLT Reference Thresholds</h4>
            <p>For clinical consideration only:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li>‚â•10% decline: Consider potential BOS evaluation</li>
                <li>‚â•20% decline: Consider further investigation</li>
                <li>‚â•35% decline: Consider urgent evaluation</li>
            </ul>
            <small>Note: Clinical correlation and sustained decline required for diagnosis.</small>
        </div>
        
        <div class="action-buttons">
            <button class="btn-secondary" onclick="saveCurrentCalculation()">Save Visit</button>
            <button class="btn-primary" onclick="exportPatientData()">Export Data</button>
        </div>
    `;
    
    elements.quickResults.innerHTML = html;
    elements.quickResults.classList.remove('hidden');
}

// ===== TIMELINE CALCULATIONS =====

function updateTimelineCalculations() {
    if (!state.currentPatient) return;
    
    const patient = state.patients.get(state.currentPatient);
    if (!patient.transplantDate) return;
    
    const today = new Date().toISOString().split('T')[0];
    const daysSinceTx = daysBetween(patient.transplantDate, today);
    
    let html = `
        <div class="timeline-row">
            <span class="timeline-label">Transplant Date</span>
            <span class="timeline-value">${formatDate(patient.transplantDate)}</span>
        </div>
        <div class="timeline-row">
            <span class="timeline-label">Days since transplant</span>
            <span class="timeline-value">${daysSinceTx} days</span>
        </div>
        <div class="timeline-row">
            <span class="timeline-label">Years since transplant</span>
            <span class="timeline-value">${(daysSinceTx / 365.25).toFixed(1)} years</span>
        </div>
    `;
    
    if (patient.visits.length > 0) {
        const lastVisit = patient.visits[patient.visits.length - 1];
        const daysSinceLast = daysBetween(lastVisit.date, today);
        
        html += `
            <div class="timeline-row">
                <span class="timeline-label">Last visit</span>
                <span class="timeline-value">${formatDate(lastVisit.date)} (${daysSinceLast} days ago)</span>
            </div>
        `;
        
        // Calculate overall trend if multiple visits
        if (patient.visits.length > 1) {
            const firstVisit = patient.visits[0];
            const totalDays = daysBetween(firstVisit.date, today);
            const fev1Change = lastVisit.fev1 - firstVisit.fev1;
            const rate = (fev1Change / (totalDays / 30.44)).toFixed(3);
            
            html += `
                <div class="timeline-row">
                    <span class="timeline-label">Overall FEV‚ÇÅ trend</span>
                    <span class="timeline-value ${fev1Change < 0 ? 'value-negative' : 'value-positive'}">
                        ${rate} L/month
                    </span>
                </div>
            `;
        }
    }
    
    elements.timelineAnalysis.innerHTML = html;
}

// ===== MODE MANAGEMENT =====

function switchMode(mode) {
    state.mode = mode;
    
    // Update mode buttons
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(mode === 'quick' ? 'Quick' : 
                                                              mode === 'full' ? 'Full' : 'Review'));
    });
    
    // Show/hide modes
    elements.modeQuick.classList.toggle('hidden', mode !== 'quick');
    elements.modeFull.classList.toggle('hidden', mode !== 'full');
    elements.modeReview.classList.toggle('hidden', mode !== 'review');
    
    // Load data for current mode
    if (mode === 'full' && state.currentPatient) {
        loadPatientData();
    } else if (mode === 'review') {
        updateReviewMode();
    }
}

function loadPatientData() {
    if (!state.currentPatient) return;
    
    const patient = state.patients.get(state.currentPatient);
    
    // Load transplant date
    if (patient.transplantDate) {
        elements.transplantDate.value = patient.transplantDate;
    }
    
    // Load baseline
    if (patient.baselineFev1) {
        elements.baselineFev1.value = patient.baselineFev1;
    }
    
    // Update timeline
    updateTimelineCalculations();
}

// ===== UTILITY FUNCTIONS =====

function daysBetween(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    const diff = Math.abs(d2 - d1);
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function setTodayDates() {
    const today = new Date().toISOString().split('T')[0];
    elements.newTransplantDate.value = today;
    elements.transplantDate.value = today;
}

function clearQuickInputs() {
    elements.quickFev1.value = '';
    elements.quickFvc.value = '';
    elements.quickResults.classList.add('hidden');
    elements.quickFev1.focus();
}

function saveCurrentCalculation() {
    if (!state.currentPatient) return;
    
    const fev1 = parseFloat(elements.quickFev1.value);
    const fvc = parseFloat(elements.quickFvc.value);
    
    if (!fev1 || !fvc) return;
    
    const patient = state.patients.get(state.currentPatient);
    patient.visits.push({
        date: new Date().toISOString().split('T')[0],
        fev1: fev1,
        fvc: fvc,
        calculatedAt: new Date().toISOString()
    });
    
    // Save baseline if not set and this is first visit
    if (!patient.baselineFev1) {
        patient.baselineFev1 = fev1;
        elements.baselineFev1.value = fev1;
    }
    
    saveToStorage();
    updateTimelineCalculations();
    
    alert('Visit saved successfully');
}

function exportPatientData() {
    if (!state.currentPatient) return;
    
    const patient = state.patients.get(state.currentPatient);
    const data = {
        patient: patient,
        exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${patient.id}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function updateReviewMode() {
    let html = '<div class="patient-grid">';
    
    state.patients.forEach(patient => {
        const lastVisit = patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
        
        html += `
            <div class="patient-card" onclick="selectPatient('${patient.id}'); switchMode('full')">
                <div class="patient-id">${patient.id}</div>
                <div class="patient-stats">${patient.visits.length} visits</div>
                ${lastVisit ? `
                    <div class="patient-stats">Last: ${formatDate(lastVisit.date)}</div>
                    <div class="patient-stats">FEV‚ÇÅ: ${lastVisit.fev1.toFixed(2)} L</div>
                ` : '<div class="patient-stats">No visits yet</div>'}
            </div>
        `;
    });
    
    html += '</div>';
    elements.allPatientsSummary.innerHTML = html;
}

// ===== STORAGE =====

function saveToStorage() {
    try {
        const data = {
            patients: Array.from(state.patients.entries()),
            nextPatientId: state.nextPatientId,
            currentPatient: state.currentPatient
        };
        localStorage.setItem('neumocalc_timeline', JSON.stringify(data));
    } catch (e) {
        console.warn('Failed to save data:', e);
    }
}

function loadFromStorage() {
    try {
        const saved = localStorage.getItem('neumocalc_timeline');
        if (saved) {
            const data = JSON.parse(saved);
            
            // Restore patients Map
            state.patients = new Map(data.patients || []);
            state.nextPatientId = data.nextPatientId || 1;
            state.currentPatient = data.currentPatient;
            
            // Select first patient if none selected
            if (!state.currentPatient && state.patients.size > 0) {
                state.currentPatient = Array.from(state.patients.keys())[0];
            }
        }
    } catch (e) {
        console.warn('Failed to load data:', e);
    }
}

// ===== MODAL FUNCTIONS =====

function showNewPatientModal() {
    elements.newPatientId.value = generatePatientId();
    elements.newPatientModal.classList.add('active');
}

function hideModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ===== INITIALIZATION =====
console.log('NeumoCalc Timeline Calculator loaded');
</script>
</body>
</html>
