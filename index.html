<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1A5F7A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Spirolite v1.4 - Professional Post-Transplant Lung Function Tracker">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Spiro<span style="color: #1A5F7A; font-weight: 800">lite</span> v1.4 | Transplant Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg?v=1.4" id="favicon-svg">
    <link rel="alternate icon" type="image/png" sizes="192x192" href="icon-192.png?v=1.4">
    <link rel="alternate icon" type="image/png" sizes="512x512" href="icon-512.png?v=1.4">
    <link rel="apple-touch-icon" href="icon-192.png?v=1.4">
    <meta name="apple-mobile-web-app-title" content="Spirolite">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ===== CSS RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            /* Professional Medical Color Palette */
            --primary: #1A5F7A;
            --primary-dark: #0D4B63;
            --primary-light: #2D9596;
            --secondary: #57C5B6;
            --accent: #FF9E6D;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --surface-elevated: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-tertiary: #9CA3AF;
            --success: #059669;
            --success-light: #D1FAE5;
            --warning: #D97706;
            --warning-light: #FEF3C7;
            --alert: #DC2626;
            --alert-light: #FEE2E2;
            --info: #2563EB;
            --border: #E5E7EB;
            --border-light: #F3F4F6;
            --chart-line: #1A5F7A;
            --chart-fill: rgba(26, 95, 122, 0.1);
            --chart-point: #2D9596;
            
            /* Date Status Colors */
            --date-missing: #DC2626;
            --date-recent: #D97706;
            --date-valid: #059669;
            
            /* Glass Effects */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            --glass-blur: blur(10px);
            --glass-bg-dark: rgba(31, 41, 55, 0.85);
            --glass-border-dark: rgba(255, 255, 255, 0.1);
            
            /* Spacing Scale */
            --space-0: 0px;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.5rem;
            --space-6: 2rem;
            --space-7: 2.5rem;
            --space-8: 3rem;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, 'SF Pro Display', sans-serif;
            --font-family-mono: 'SF Mono', 'Roboto Mono', 'JetBrains Mono', monospace;
            
            /* Border Radius */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.12);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-index layers */
            --z-base: 1;
            --z-elevated: 10;
            --z-sticky: 100;
            --z-modal: 1000;
            --z-toast: 10000;
            --z-loading: 100000;
        }
        
        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #2D9596;
                --primary-dark: #1A5F7A;
                --primary-light: #57C5B6;
                --background: #111827;
                --surface: #1F2937;
                --surface-elevated: #374151;
                --text-primary: #F9FAFB;
                --text-secondary: #D1D5DB;
                --text-tertiary: #9CA3AF;
                --border: #374151;
                --border-light: #4B5563;
                --success-light: #064E3B;
                --warning-light: #78350F;
                --alert-light: #7F1D1D;
                --chart-line: #57C5B6;
                --chart-fill: rgba(87, 197, 182, 0.1);
                --chart-point: #2D9596;
                --glass-bg: rgba(31, 41, 55, 0.85);
                --glass-border: rgba(255, 255, 255, 0.1);
            }
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        @media (prefers-color-scheme: dark) {
            html {
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            }
        }
        
        body {
            font-family: var(--font-family);
            background: transparent;
            color: var(--text-primary);
            line-height: 1.5;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* ===== ENHANCED LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: var(--z-loading);
            opacity: 1;
            transition: opacity var(--transition-slow) ease;
        }
        
        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            padding: var(--space-6);
            max-width: 320px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .loading-logo {
            width: 100px;
            height: 100px;
            margin-bottom: var(--space-5);
            position: relative;
            animation: float 3s ease-in-out infinite;
        }
        
        .loading-logo-inner {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .loading-logo-inner::before {
            content: '';
            background-image: url('icon.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 100%;
            height: 100%;
            display: block;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .loading-progress-container {
            width: 100%;
            max-width: 280px;
            margin: var(--space-5) 0;
        }
        
        .loading-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 0.75rem;
            color: white;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .loading-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), white);
            width: 0%;
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .loading-text {
            font-size: 0.875rem;
            color: white;
            margin-top: var(--space-4);
            font-weight: 600;
            text-align: center;
            line-height: 1.4;
            opacity: 0.9;
        }
        
        /* ===== APP CONTAINER ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .app-container.loaded {
            opacity: 1;
        }
        
        @media (min-width: 768px) {
            .app-container {
                margin: var(--space-4) auto;
                height: calc(100vh - 2 * var(--space-4));
                max-height: 900px;
                border-radius: var(--radius-xl);
                overflow: hidden;
                box-shadow: var(--shadow-xl);
            }
        }
        
        /* ===== COLLAPSIBLE HEADER WITH TRANSPLANT DATE ===== */
        .app-header {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--space-3) var(--space-4);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-header.collapsed {
            padding: var(--space-2) var(--space-4);
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-4);
            flex: 1;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
            min-width: 0;
        }
        
        .app-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(26, 95, 122, 0.3);
        }
        
        .app-logo::before {
            content: '';
            background-image: url('icon.svg');
            background-size: 60%;
            background-repeat: no-repeat;
            background-position: center;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .app-name {
            flex: 1;
            min-width: 0;
        }
        
        .app-name h1 {
            font-size: 1.125rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .app-name h1 .lite {
            color: var(--primary);
            font-weight: 900;
        }
        
        .app-name span {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            font-weight: 500;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-1);
            flex-shrink: 0;
            align-items: center;
        }
        
        /* ===== COMPACT PATIENT BAR WITH TRANSPLANT DATE STATUS ===== */
        .patient-bar {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: var(--space-2) var(--space-4);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            transition: all var(--transition-normal);
        }
        
        .patient-bar.collapsed {
            padding: var(--space-1) var(--space-4);
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        
        .patient-info-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
        }
        
        .patient-id-display {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            min-width: 0;
        }
        
        .patient-avatar-small {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(26, 95, 122, 0.3);
            border: 2px solid white;
        }
        
        .patient-meta-compact {
            flex: 1;
            min-width: 0;
        }
        
        .patient-meta-compact .primary {
            font-family: var(--font-family-mono);
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .tx-date-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }
        
        .tx-date-status.missing {
            background: var(--alert-light);
            color: var(--alert);
        }
        
        .tx-date-status.recent {
            background: var(--warning-light);
            color: var(--warning);
        }
        
        .tx-date-status.valid {
            background: var(--success-light);
            color: var(--success);
        }
        
        .patient-meta-compact .secondary {
            font-size: 0.625rem;
            color: var(--text-secondary);
            display: flex;
            gap: var(--space-2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .patient-actions-compact {
            display: flex;
            gap: var(--space-1);
            flex-shrink: 0;
        }
        
        /* ===== HEADER BUTTONS ===== */
        .header-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: var(--radius-md);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 1rem;
        }
        
        .header-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .header-btn:active {
            transform: translateY(0);
        }
        
        .header-btn.small {
            width: 36px;
            height: 36px;
            min-width: 36px;
            font-size: 0.875rem;
        }
        
        /* ===== NAVIGATION ===== */
        .app-navigation {
            display: flex;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: var(--space-2) var(--space-4);
            gap: var(--space-1);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            transition: all var(--transition-normal);
        }
        
        .app-navigation.collapsed {
            top: -48px;
        }
        
        .app-navigation::-webkit-scrollbar {
            display: none;
        }
        
        .nav-btn {
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-lg);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 75px;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .nav-btn:hover {
            background: rgba(26, 95, 122, 0.1);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(26, 95, 122, 0.3);
            transform: translateY(0);
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: var(--space-4);
            padding-bottom: max(var(--space-4), env(safe-area-inset-bottom));
        }
        
        /* ===== MODE SECTIONS ===== */
        .mode-section {
            display: none;
            animation: fadeIn var(--transition-normal);
        }
        
        .mode-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* ===== CARD COMPONENT ===== */
        .calculator-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
        }
        
        .section-title .badge {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: 0.6875rem;
            font-weight: 600;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* ===== FORM COMPONENTS ===== */
        .input-group {
            position: relative;
            margin-bottom: var(--space-3);
        }
        
        .input-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .input-help {
            color: var(--text-tertiary);
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .measurement-input {
            width: 100%;
            padding: var(--space-3);
            padding-right: 50px;
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            font-family: var(--font-family-mono);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            text-align: left;
            transition: all var(--transition-fast);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .measurement-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.2);
            transform: translateY(-1px);
        }
        
        .measurement-input.invalid {
            border-color: var(--alert);
            background: rgba(220, 38, 38, 0.1);
        }
        
        .measurement-input.compact {
            font-size: 0.875rem;
            padding: var(--space-2) var(--space-3);
            font-weight: 600;
        }
        
        .input-unit {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            pointer-events: none;
        }
        
        /* ===== VALIDATION MESSAGES ===== */
        .validation-message {
            font-size: 0.6875rem;
            margin-top: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md);
            display: none;
        }
        
        .validation-message.warning {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.3);
            display: block;
        }
        
        .validation-message.error {
            background: var(--alert-light);
            color: var(--alert);
            border: 1px solid rgba(220, 38, 38, 0.3);
            display: block;
        }
        
        .validation-message.success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.3);
            display: block;
        }
        
        /* ===== PERCENTAGE DISPLAY STYLES ===== */
        .value-with-percent {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
            justify-content: center;
        }
        
        .primary-value {
            font-family: var(--font-family-mono);
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
        }
        
        .percent-display {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            transition: all var(--transition-fast);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .percent-display.good {
            background: rgba(5, 150, 105, 0.2);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.3);
        }
        
        .percent-display.warning {
            background: rgba(217, 119, 6, 0.2);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.3);
        }
        
        .percent-display.alert {
            background: rgba(220, 38, 38, 0.2);
            color: var(--alert);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        .percent-display.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-tertiary);
            border: 1px solid rgba(156, 163, 175, 0.3);
        }
        
        /* ===== QUICK CALC MODE ===== */
        .measurement-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        @media (max-width: 640px) {
            .measurement-inputs {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }
        }
        
        /* ===== RESULTS PANEL ===== */
        .results-panel {
            margin-top: var(--space-4);
            display: none;
        }
        
        .results-panel.visible {
            display: block;
            animation: fadeIn var(--transition-normal);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .results-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .results-timestamp {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
        }
        
        .current-measurements {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            border: 1px solid var(--glass-border);
        }
        
        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
        }
        
        @media (max-width: 480px) {
            .measurements-grid {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }
        }
        
        .measurement-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.8),
                rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        @media (prefers-color-scheme: dark) {
            .measurement-card {
                background: linear-gradient(135deg, 
                    rgba(31, 41, 55, 0.8),
                    rgba(30, 41, 59, 0.6));
            }
        }
        
        .measurement-label {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: block;
        }
        
        .measurement-unit {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        /* ===== COMPARISON ANALYSIS ===== */
        .comparison-results {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            border: 1px solid var(--glass-border);
        }
        
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .comparison-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .comparison-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .metric-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-item:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .metric-value {
            font-family: var(--font-family-mono);
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .visit-change {
            transition: all var(--transition-fast);
        }
        
        .visit-change.positive {
            color: var(--success);
        }
        
        .visit-change.negative {
            color: var(--alert);
        }
        
        .visit-change.neutral {
            color: var(--text-tertiary);
        }
        
        .baseline-percent {
            transition: all var(--transition-fast);
        }
        
        .baseline-percent.good {
            background: rgba(5, 150, 105, 0.2);
            color: var(--success);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            border: 1px solid rgba(5, 150, 105, 0.3);
        }
        
        .baseline-percent.warning {
            background: rgba(217, 119, 6, 0.2);
            color: var(--warning);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            border: 1px solid rgba(217, 119, 6, 0.3);
        }
        
        .baseline-percent.alert {
            background: rgba(220, 38, 38, 0.2);
            color: var(--alert);
            padding: 4px 8px;
            border-radius: var(--radius-full);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        .metric-unit {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            min-width: 50px;
            text-align: right;
        }
        
        /* ===== TIME CONTEXT DISPLAY ===== */
        .time-context {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-top: var(--space-3);
            border: 1px solid var(--glass-border);
        }
        
        .time-context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .time-context-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-bar {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @media (max-width: 640px) {
            .action-bar {
                flex-direction: column;
                gap: var(--space-2);
            }
        }
        
        .action-btn {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
            min-height: 40px;
        }
        
        @media (max-width: 640px) {
            .action-btn {
                width: 100%;
            }
        }
        
        .action-btn:active {
            transform: translateY(0);
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, 
                rgba(26, 95, 122, 0.9),
                rgba(13, 75, 99, 0.9));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            box-shadow: 0 4px 15px rgba(26, 95, 122, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn.primary:hover {
            box-shadow: 0 6px 20px rgba(26, 95, 122, 0.4);
            transform: translateY(-1px);
        }
        
        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }
        
        @media (prefers-color-scheme: dark) {
            .action-btn.secondary {
                background: rgba(31, 41, 55, 0.8);
            }
        }
        
        /* ===== MONITOR MODE SPECIFIC ===== */
        .monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .view-toggle {
            display: flex;
            gap: 2px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            padding: 2px;
            border: 1px solid var(--glass-border);
        }
        
        .view-toggle-btn {
            padding: var(--space-1) var(--space-2);
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.6875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        
        .view-toggle-btn:hover {
            background: rgba(26, 95, 122, 0.1);
            color: var(--primary);
        }
        
        .view-toggle-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(26, 95, 122, 0.3);
        }
        
        .baseline-control {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        .baseline-value-display {
            font-family: var(--font-family-mono);
            font-weight: 700;
            color: var(--primary);
            font-size: 0.875rem;
            background: rgba(26, 95, 122, 0.1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md);
            border: 1px solid rgba(26, 95, 122, 0.2);
        }
        
        .baseline-set-btn {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md);
            background: var(--success);
            color: white;
            border: none;
            font-size: 0.6875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .baseline-set-btn:hover {
            background: var(--success);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        }
        
        .baseline-set-btn:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .visit-entry-form {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            border: 1px solid var(--glass-border);
        }
        
        .form-row {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }
        
        @media (max-width: 640px) {
            .form-row {
                flex-wrap: wrap;
            }
        }
        
        .date-input {
            padding: var(--space-2);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: 0.75rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-primary);
            flex: 1;
            min-width: 120px;
        }
        
        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 95, 122, 0.2);
        }
        
        .date-input.invalid {
            border-color: var(--alert);
            background: rgba(220, 38, 38, 0.1);
        }
        
        .date-warning {
            font-size: 0.6875rem;
            color: var(--warning);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .date-warning.error {
            color: var(--alert);
        }
        
        /* ===== VISITS TABLE ===== */
        .visits-table-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            overflow: hidden;
            margin-bottom: var(--space-4);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: rgba(26, 95, 122, 0.1);
            border-bottom: 1px solid var(--glass-border);
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .medical-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 800px;
        }
        
        .medical-table th {
            background: rgba(26, 95, 122, 0.1);
            padding: var(--space-2);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.6875rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--glass-border);
            text-align: left;
            white-space: nowrap;
        }
        
        .medical-table td {
            padding: var(--space-2);
            border-bottom: 1px solid var(--glass-border);
            font-family: var(--font-family-mono);
            white-space: nowrap;
            vertical-align: top;
        }
        
        .medical-table tr:hover {
            background: rgba(26, 95, 122, 0.05);
        }
        
        .medical-table .baseline-cell {
            font-weight: 700;
            color: var(--primary);
        }
        
        /* ===== TIMELINE VIEW ===== */
        .timeline-view {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-border);
            overflow: hidden;
            margin-bottom: var(--space-4);
            display: none;
        }
        
        .timeline-view.visible {
            display: block;
        }
        
        .timeline-container {
            padding: var(--space-3);
        }
        
        .timeline-chart-container {
            height: 200px;
            position: relative;
            margin-bottom: var(--space-3);
        }
        
        /* ===== VISUALIZATION ===== */
        .chart-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            height: 250px;
            position: relative;
            margin-bottom: var(--space-3);
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-4);
            animation: fadeIn var(--transition-normal);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95),
                rgba(255, 255, 255, 0.85));
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: slideUp var(--transition-normal) cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (prefers-color-scheme: dark) {
            .modal-content {
                background: linear-gradient(135deg, 
                    rgba(30, 41, 59, 0.95),
                    rgba(15, 23, 42, 0.85));
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-full);
            border: none;
            background: rgba(156, 163, 175, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 1rem;
        }
        
        .modal-body {
            padding: var(--space-4);
        }
        
        .modal-footer {
            padding: var(--space-3) var(--space-4);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        @media (max-width: 640px) {
            .toast-container {
                left: 20px;
                right: 20px;
                bottom: 80px;
            }
        }
        
        .toast {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95),
                rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary);
            max-width: 300px;
            animation: slideInRight var(--transition-normal);
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.error { border-left-color: var(--alert); }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-logo">
                <div class="loading-logo-inner"></div>
            </div>
            
            <div class="loading-progress-container">
                <div class="loading-progress-label">
                    <span id="loadingStep">Initializing Spirolite v1.4...</span>
                    <span id="loadingPercent">0%</span>
                </div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loadingProgressBar"></div>
                </div>
            </div>
            
            <div class="loading-text" id="loadingText">Transplant Date is the Foundation</div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header" id="appHeader">
            <div class="header-content">
                <div class="app-title">
                    <div class="app-logo" title="Spirolite"></div>
                    <div class="app-name">
                        <h1><span>Spiro</span><span class="lite">lite</span> <span style="font-size: 0.75rem; color: var(--text-tertiary);">v1.4</span></h1>
                        <span>Transplant Lung Function Tracker</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="protocolSettingsBtn" title="Protocol Settings">
                        <span></span>
                    </button>
                    <button class="header-btn" id="exportBtn" title="Export Data">
                        <span></span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Compact Patient Bar -->
        <div class="patient-bar" id="patientBar">
            <div class="patient-info-compact">
                <div class="patient-id-display">
                    <div class="patient-avatar-small" id="patientAvatar">--</div>
                    <div class="patient-meta-compact">
                        <div class="primary">
                            <span id="patientIdDisplay">No Patient</span>
                            <span id="txDateStatus" class="tx-date-status missing"> No Tx Date</span>
                        </div>
                        <div class="secondary">
                            <span id="patientTxDateDisplay">--</span>
                            <span></span>
                            <span id="visitsCountCompact">0 visits</span>
                            <span></span>
                            <span id="currentBaselineDisplay">No baseline</span>
                        </div>
                    </div>
                </div>
                <div class="patient-actions-compact">
                    <button class="header-btn small" id="newPatientBtn" title="New Patient">
                        <span></span>
                    </button>
                    <button class="header-btn small" id="patientListBtn" title="Patient List">
                        <span></span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="app-navigation" id="appNavigation">
            <button class="nav-btn active" data-mode="quick">
                <span></span>
                <span>Quick Calc</span>
            </button>
            <button class="nav-btn" data-mode="monitor">
                <span></span>
                <span>Monitor</span>
            </button>
            <button class="nav-btn" data-mode="settings">
                <span></span>
                <span>Settings</span>
            </button>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Calc Mode -->
            <div id="modeQuick" class="mode-section active">
                <div class="calculator-card">
                    <div class="section-title">
                        <span>Quick Calculation</span>
                        <span class="badge" id="quickPatientBadge">No Patient</span>
                    </div>
                    
                    <div class="measurement-inputs">
                        <div class="input-group">
                            <div class="input-label">
                                <span>FEV</span>
                                <span class="input-help">Forced Expiratory Volume in 1 second</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" 
                                       step="0.01" 
                                       min="0.5" 
                                       max="8.0" 
                                       class="measurement-input" 
                                       id="inputFev1"
                                       placeholder="2.85"
                                       autofocus
                                       required
                                       aria-label="FEV1 measurement in liters">
                                <span class="input-unit">L</span>
                            </div>
                            <div class="validation-message" id="fev1Validation"></div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-label">
                                <span>FVC</span>
                                <span class="input-help">Forced Vital Capacity (optional)</span>
                            </div>
                            <div class="input-wrapper">
                                <input type="number" 
                                       step="0.01" 
                                       min="0.5" 
                                       max="10.0" 
                                       class="measurement-input" 
                                       id="inputFvc"
                                       placeholder="3.40"
                                       aria-label="FVC measurement in liters">
                                <span class="input-unit">L</span>
                            </div>
                            <div class="validation-message" id="fvcValidation"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Results Panel -->
                <div class="results-panel" id="resultsPanel">
                    <div class="results-header">
                        <div class="results-title">Objective Measurements</div>
                        <div class="results-timestamp" id="resultsTimestamp"></div>
                    </div>
                    
                    <!-- Current Measurements -->
                    <div class="current-measurements">
                        <div class="measurements-grid">
                            <div class="measurement-card">
                                <span class="measurement-label">FEV</span>
                                <div class="value-with-percent">
                                    <div class="primary-value" id="resultFev1Liters">--</div>
                                    <div class="percent-display neutral" id="resultFev1Percent">--%</div>
                                </div>
                                <span class="measurement-unit">Liters (Percentage)</span>
                            </div>
                            <div class="measurement-card">
                                <span class="measurement-label">FVC</span>
                                <div class="primary-value" id="resultFvc">--</div>
                                <span class="measurement-unit">Liters</span>
                            </div>
                            <div class="measurement-card">
                                <span class="measurement-label">FEV/FVC Ratio</span>
                                <div class="primary-value" id="resultRatio">--</div>
                                <span class="measurement-unit">Percentage</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Analysis -->
                    <div class="comparison-results" id="comparisonResults">
                        <div class="comparison-header">
                            <div class="comparison-title">Comparison Analysis</div>
                            <div class="comparison-subtitle" id="comparisonSubtitle"></div>
                        </div>
                        
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">
                                    <span> from Last Visit</span>
                                </span>
                                <span class="metric-value visit-change neutral" id="resultVisitDelta">--</span>
                                <span class="metric-unit" id="resultVisitPercent">--%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">
                                    <span>% of Baseline</span>
                                </span>
                                <span class="metric-value baseline-percent neutral" id="resultBaselinePercent">--%</span>
                                <span class="metric-unit" id="resultBaselineDelta">-- L</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Context -->
                    <div class="time-context" id="timeContext">
                        <div class="time-context-header">
                            <div class="time-context-title">Time Context</div>
                        </div>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Days post-Tx</span>
                                <span class="metric-value" id="daysPostTx">--</span>
                                <span class="metric-unit" id="yearsPostTx">--</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Since last visit</span>
                                <span class="metric-value" id="daysSinceLast">--</span>
                                <span class="metric-unit">days</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Rate of change</span>
                                <span class="metric-value" id="rateOfChange">--</span>
                                <span class="metric-unit">L/month</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-bar">
                    <button class="action-btn secondary" id="clearQuickBtn" aria-label="Clear all inputs">
                        <span></span>
                        <span>Clear</span>
                    </button>
                    <button class="action-btn primary" id="saveQuickBtn" aria-label="Save current visit">
                        <span></span>
                        <span>Save Visit</span>
                    </button>
                </div>
            </div>
            
            <!-- Monitor Mode -->
            <div id="modeMonitor" class="mode-section">
                <div class="calculator-card">
                    <div class="monitor-header">
                        <div class="section-title">
                            <span>Patient Monitoring</span>
                            <span class="badge" id="monitorPatientBadge">No Patient</span>
                        </div>
                        
                        <!-- View Toggle -->
                        <div class="view-toggle">
                            <button class="view-toggle-btn active" data-view="table" aria-label="Table view">
                                <span> Table</span>
                            </button>
                            <button class="view-toggle-btn" data-view="timeline" aria-label="Timeline view">
                                <span> Timeline</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Baseline Control -->
                    <div class="baseline-control">
                        <div class="input-label">
                            <span>Baseline FEV</span>
                            <span class="input-help">Set post-transplant when stable</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2); flex: 1;">
                            <input type="number" 
                                   step="0.01" 
                                   min="0.5" 
                                   max="8.0" 
                                   class="measurement-input compact" 
                                   id="manualBaselineInput"
                                   placeholder="Enter baseline FEV"
                                   style="flex: 1;"
                                   aria-label="Manual baseline FEV1 input">
                            <span class="baseline-value-display" id="currentBaselineValue" style="display: none;">--</span>
                            <button class="baseline-set-btn" id="setBaselineBtn" aria-label="Set baseline">
                                <span></span>
                                <span>Set</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Add Visit Form -->
                    <div class="visit-entry-form">
                        <div class="input-label">
                            <span>Add Visit</span>
                            <span class="input-help">Date must be on/after transplant date</span>
                        </div>
                        <div class="form-row">
                            <div style="flex: 1; min-width: 120px;">
                                <input type="date" class="date-input" id="visitDate" required aria-label="Visit date">
                                <div class="date-warning hidden" id="dateIntervalWarning"></div>
                            </div>
                            <input type="number" step="0.01" min="0.5" max="8.0" 
                                   class="measurement-input compact" 
                                   id="visitFev1" placeholder="FEV (L)" required aria-label="Visit FEV1">
                            <input type="number" step="0.01" min="0.5" max="10.0" 
                                   class="measurement-input compact" 
                                   id="visitFvc" placeholder="FVC (L)" aria-label="Visit FVC">
                            <button class="header-btn" id="addVisitBtn" title="Add Visit" aria-label="Add visit">
                                <span></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table View -->
                    <div class="visits-table-container" id="tableView">
                        <div class="table-header">
                            <span style="font-weight: 600; font-size: 0.75rem;">Visit History</span>
                            <div style="display: flex; gap: var(--space-2); align-items: center;">
                                <button class="header-btn small" id="exportPDFBtn" title="Export PDF Report" aria-label="Export PDF">
                                    <span></span>
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="medical-table" aria-label="Patient visits table">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">Days post-Tx</th>
                                        <th scope="col">FEV (L)</th>
                                        <th scope="col">% of Baseline</th>
                                        <th scope="col">FVC</th>
                                        <th scope="col">Ratio</th>
                                        <th scope="col"> from Last</th>
                                        <th scope="col">Days since last</th>
                                        <th scope="col">Rate (L/month)</th>
                                        <th scope="col">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center" style="padding: var(--space-4); color: var(--text-tertiary);">
                                            No visits yet. Add visits using the form above.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Timeline View -->
                    <div class="timeline-view" id="timelineView">
                        <div class="table-header">
                            <span style="font-weight: 600; font-size: 0.75rem;">Patient Timeline</span>
                        </div>
                        <div class="timeline-container">
                            <div class="timeline-chart-container">
                                <canvas id="timelineChart" aria-label="Timeline chart of FEV1 measurements"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Mode -->
            <div id="modeSettings" class="mode-section">
                <div class="calculator-card">
                    <div class="section-title">
                        <span>Settings & Data Management</span>
                    </div>
                    
                    <div class="visit-entry-form">
                        <div class="input-label">Data Management</div>
                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <button class="action-btn secondary" id="exportAllDataBtn">
                                <span></span>
                                <span>Export All Data</span>
                            </button>
                            <button class="action-btn secondary" id="importDataBtn">
                                <span></span>
                                <span>Import Data</span>
                            </button>
                            <button class="action-btn secondary" id="clearAllDataBtn">
                                <span></span>
                                <span>Clear All Data</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="visit-entry-form mt-3">
                        <div class="input-label">Application Settings</div>
                        <div class="form-row">
                            <label style="display: flex; align-items: center; gap: var(--space-2); flex: 1;">
                                <input type="checkbox" id="colorCodingToggle" checked>
                                <span style="font-size: 0.75rem;">Color coding</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2); flex: 1;">
                                <input type="checkbox" id="autoSaveToggle" checked>
                                <span style="font-size: 0.75rem;">Auto-save</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Protocol Settings Modal -->
    <div class="modal-overlay" id="protocolModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Protocol Settings</div>
                <button class="modal-close" id="closeProtocolModal" aria-label="Close modal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <div class="input-label">Monitor Threshold</div>
                    <input type="number" 
                           min="5" 
                           max="50" 
                           step="1" 
                           class="measurement-input compact" 
                           id="monitorThreshold"
                           value="10">
                    <div class="notes-hint">Show monitor alert at this decline from baseline (%)</div>
                </div>
                
                <div class="input-group mb-3">
                    <div class="input-label">Review Threshold</div>
                    <input type="number" 
                           min="10" 
                           max="50" 
                           step="1" 
                           class="measurement-input compact" 
                           id="reviewThreshold"
                           value="20">
                    <div class="notes-hint">Show review alert at this decline from baseline (%)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="resetProtocolBtn">
                    <span></span>
                    <span>Reset Defaults</span>
                </button>
                <button class="action-btn primary" id="saveProtocolBtn">
                    <span></span>
                    <span>Save</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- New Patient Modal -->
    <div class="modal-overlay" id="newPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Patient</div>
                <button class="modal-close" id="closeNewPatientModal" aria-label="Close modal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <div class="input-label">Patient ID</div>
                    <input type="text" 
                           class="measurement-input compact" 
                           id="newPatientId"
                           placeholder="PT001"
                           autofocus
                           required
                           pattern="[A-Za-z0-9]{3,10}"
                           title="3-10 characters, letters and numbers only"
                           aria-label="Patient ID">
                </div>
                <div class="input-group mb-3">
                    <div class="input-label">Transplant Date</div>
                    <input type="date" 
                           class="date-input" 
                           id="newTxDate"
                           required
                           aria-label="Transplant date">
                    <div class="notes-hint" style="margin-top: var(--space-1); font-size: 0.75rem; color: var(--text-secondary);">
                        Required: All calculations revolve around this date
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">Initial Baseline FEV (Optional)</div>
                    <input type="number" 
                           step="0.01" 
                           min="0.5" 
                           max="8.0" 
                           class="measurement-input compact" 
                           id="newPatientBaseline"
                           placeholder="Enter initial baseline"
                           aria-label="Initial baseline FEV1">
                    <div class="notes-hint" style="margin-top: var(--space-1); font-size: 0.75rem; color: var(--text-secondary);">
                        Can be set later when patient is stable post-transplant
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelNewPatientBtn">
                    <span></span>
                    <span>Cancel</span>
                </button>
                <button class="action-btn primary" id="createPatientBtn">
                    <span></span>
                    <span>Create Patient</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Patient List Modal -->
    <div class="modal-overlay" id="patientListModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Select Patient</div>
                <button class="modal-close" id="closePatientListModal" aria-label="Close modal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div id="patientList">
                    <div class="empty-state" style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">
                        <div style="font-size: 2rem; margin-bottom: var(--space-2);"></div>
                        <p>No patients yet</p>
                        <p class="notes-hint mt-2">Create your first patient to get started</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn primary" id="addNewPatientBtn">
                    <span></span>
                    <span>Add New Patient</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Baseline Change Confirmation Modal -->
    <div class="modal-overlay" id="baselineConfirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span></span> <span>Baseline Change Confirmation</span>
                </div>
                <button class="modal-close" id="closeBaselineConfirmModal" aria-label="Close modal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--space-3);">
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-3); font-size: 0.875rem;">
                        Changing the baseline affects ALL historical percentages!
                    </p>
                    <div class="current-measurements" style="margin: var(--space-3) 0;">
                        <div style="display: flex; gap: var(--space-3);">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Previous Baseline</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--primary);" id="previousBaselineValue">
                                    --
                                </div>
                                <div style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px;" id="previousBaselineDate">
                                    --
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">New Baseline</div>
                                <div style="font-family: var(--font-family-mono); font-size: 1.25rem; font-weight: 700; color: var(--secondary);" id="newBaselineValue">
                                    --
                                </div>
                                <div style="font-size: 0.6875rem; color: var(--text-tertiary); margin-top: 2px;" id="newBaselineDate">
                                    --
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelBaselineChangeBtn">
                    <span></span>
                    <span>Cancel</span>
                </button>
                <button class="action-btn secondary" id="keepOldBaselineBtn">
                    <span></span>
                    <span>Keep Old</span>
                </button>
                <button class="action-btn primary" id="updateAllBaselineBtn">
                    <span></span>
                    <span>Update All</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Duplicate Date Modal -->
    <div class="modal-overlay" id="duplicateDateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><span></span> <span>Visit Already Exists</span></div>
                <button class="modal-close" id="closeDuplicateModal" aria-label="Close modal">
                    <span></span>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--space-3);">
                    <p id="duplicateDateMessage"></p>
                    <div class="notes-hint" style="font-size: 0.6875rem; color: var(--text-tertiary);">
                        What would you like to do?
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" id="cancelDuplicateBtn">
                    <span></span>
                    <span>Cancel</span>
                </button>
                <button class="action-btn secondary" id="addAsNewBtn">
                    <span></span>
                    <span>Add as New (+1 day)</span>
                </button>
                <button class="action-btn primary" id="replaceExistingBtn">
                    <span></span>
                    <span>Replace Existing</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
    // ============================================
    // SPIROLITE v1.4 - TRANSPLANT TRACKER
    // Core Principle: Transplant Date is the Foundation
    // ============================================

    class SpiroliteApp {
        constructor() {
            this.state = {
                mode: 'quick',
                currentPatient: null,
                patients: new Map(),
                settings: {
                    monitorThreshold: 10,
                    reviewThreshold: 20,
                    colorCoding: true,
                    autoSave: true
                },
                session: {
                    quick: {
                        fev1: null,
                        fvc: null
                    }
                }
            };
            
            this.dom = {};
            this.init();
        }
        
        async init() {
            this.showLoading('Initializing Spirolite v1.4...', 0);
            
            await this.cacheDOM();
            this.setupEventListeners();
            
            // Enhanced loading simulation
            const loadingSteps = [
                { text: 'Loading core modules...', percent: 15 },
                { text: 'Initializing database...', percent: 30 },
                { text: 'Loading patient records...', percent: 50 },
                { text: 'Setting up calculations...', percent: 70 },
                { text: 'Preparing interface...', percent: 85 },
                { text: 'Finalizing setup...', percent: 95 }
            ];
            
            let step = 0;
            const loadInterval = setInterval(() => {
                if (step < loadingSteps.length) {
                    this.updateLoading(loadingSteps[step].text, loadingSteps[step].percent);
                    step++;
                } else {
                    clearInterval(loadInterval);
                    setTimeout(() => {
                        this.updateLoading('Spirolite v1.4 ready', 100);
                        setTimeout(() => {
                            this.hideLoading();
                            this.showToast('Spirolite v1.4 - Transplant Date is the Foundation', 'success');
                        }, 800);
                    }, 600);
                }
            }, 800);
            
            this.setViewportHeight();
            this.loadState();
            this.updateUI();
        }
        
        updateLoading(text, percent) {
            const loadingStep = document.getElementById('loadingStep');
            const loadingPercent = document.getElementById('loadingPercent');
            const loadingProgressBar = document.getElementById('loadingProgressBar');
            const loadingText = document.getElementById('loadingText');
            
            if (loadingStep) loadingStep.textContent = text;
            if (loadingPercent) loadingPercent.textContent = `${percent}%`;
            if (loadingProgressBar) loadingProgressBar.style.width = `${percent}%`;
            if (loadingText) loadingText.textContent = text;
        }
        
        showLoading(text, percent) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            this.updateLoading(text, percent);
            loadingOverlay.style.display = 'flex';
            document.body.classList.add('loading');
        }
        
        hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const appContainer = document.getElementById('appContainer');
            
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                appContainer.classList.add('loaded');
                document.body.classList.remove('loading');
            }, 500);
        }
        
        setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            
            window.addEventListener('resize', () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            });
        }
        
        async cacheDOM() {
            // Loading elements
            this.dom.loadingOverlay = document.getElementById('loadingOverlay');
            this.dom.appContainer = document.getElementById('appContainer');
            
            // Header elements
            this.dom.appHeader = document.getElementById('appHeader');
            this.dom.patientBar = document.getElementById('patientBar');
            this.dom.appNavigation = document.getElementById('appNavigation');
            
            // Header actions
            this.dom.protocolSettingsBtn = document.getElementById('protocolSettingsBtn');
            this.dom.exportBtn = document.getElementById('exportBtn');
            
            // Patient context
            this.dom.patientAvatar = document.getElementById('patientAvatar');
            this.dom.patientIdDisplay = document.getElementById('patientIdDisplay');
            this.dom.txDateStatus = document.getElementById('txDateStatus');
            this.dom.patientTxDateDisplay = document.getElementById('patientTxDateDisplay');
            this.dom.visitsCountCompact = document.getElementById('visitsCountCompact');
            this.dom.currentBaselineDisplay = document.getElementById('currentBaselineDisplay');
            this.dom.newPatientBtn = document.getElementById('newPatientBtn');
            this.dom.patientListBtn = document.getElementById('patientListBtn');
            
            // Navigation
            this.dom.navBtns = document.querySelectorAll('.nav-btn');
            
            // Quick mode
            this.dom.modeQuick = document.getElementById('modeQuick');
            this.dom.quickPatientBadge = document.getElementById('quickPatientBadge');
            this.dom.inputFev1 = document.getElementById('inputFev1');
            this.dom.inputFvc = document.getElementById('inputFvc');
            this.dom.fev1Validation = document.getElementById('fev1Validation');
            this.dom.fvcValidation = document.getElementById('fvcValidation');
            
            // Quick results
            this.dom.resultsPanel = document.getElementById('resultsPanel');
            this.dom.resultsTimestamp = document.getElementById('resultsTimestamp');
            this.dom.resultFev1Liters = document.getElementById('resultFev1Liters');
            this.dom.resultFev1Percent = document.getElementById('resultFev1Percent');
            this.dom.resultFvc = document.getElementById('resultFvc');
            this.dom.resultRatio = document.getElementById('resultRatio');
            this.dom.comparisonResults = document.getElementById('comparisonResults');
            this.dom.comparisonSubtitle = document.getElementById('comparisonSubtitle');
            this.dom.resultVisitDelta = document.getElementById('resultVisitDelta');
            this.dom.resultVisitPercent = document.getElementById('resultVisitPercent');
            this.dom.resultBaselinePercent = document.getElementById('resultBaselinePercent');
            this.dom.resultBaselineDelta = document.getElementById('resultBaselineDelta');
            this.dom.timeContext = document.getElementById('timeContext');
            this.dom.daysPostTx = document.getElementById('daysPostTx');
            this.dom.yearsPostTx = document.getElementById('yearsPostTx');
            this.dom.daysSinceLast = document.getElementById('daysSinceLast');
            this.dom.rateOfChange = document.getElementById('rateOfChange');
            
            // Quick actions
            this.dom.clearQuickBtn = document.getElementById('clearQuickBtn');
            this.dom.saveQuickBtn = document.getElementById('saveQuickBtn');
            
            // Monitor mode
            this.dom.modeMonitor = document.getElementById('modeMonitor');
            this.dom.monitorPatientBadge = document.getElementById('monitorPatientBadge');
            this.dom.manualBaselineInput = document.getElementById('manualBaselineInput');
            this.dom.currentBaselineValue = document.getElementById('currentBaselineValue');
            this.dom.setBaselineBtn = document.getElementById('setBaselineBtn');
            this.dom.visitDate = document.getElementById('visitDate');
            this.dom.visitFev1 = document.getElementById('visitFev1');
            this.dom.visitFvc = document.getElementById('visitFvc');
            this.dom.dateIntervalWarning = document.getElementById('dateIntervalWarning');
            this.dom.addVisitBtn = document.getElementById('addVisitBtn');
            
            // Monitor view toggle
            this.dom.viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
            this.dom.tableView = document.getElementById('tableView');
            this.dom.timelineView = document.getElementById('timelineView');
            
            // Timeline view elements
            this.dom.timelineChart = document.getElementById('timelineChart');
            
            // Table view elements
            this.dom.visitsTableBody = document.getElementById('visitsTableBody');
            this.dom.exportPDFBtn = document.getElementById('exportPDFBtn');
            
            // Settings mode
            this.dom.modeSettings = document.getElementById('modeSettings');
            this.dom.exportAllDataBtn = document.getElementById('exportAllDataBtn');
            this.dom.importDataBtn = document.getElementById('importDataBtn');
            this.dom.clearAllDataBtn = document.getElementById('clearAllDataBtn');
            this.dom.colorCodingToggle = document.getElementById('colorCodingToggle');
            this.dom.autoSaveToggle = document.getElementById('autoSaveToggle');
            
            // Modals
            this.dom.protocolModal = document.getElementById('protocolModal');
            this.dom.closeProtocolModal = document.getElementById('closeProtocolModal');
            this.dom.monitorThreshold = document.getElementById('monitorThreshold');
            this.dom.reviewThreshold = document.getElementById('reviewThreshold');
            this.dom.resetProtocolBtn = document.getElementById('resetProtocolBtn');
            this.dom.saveProtocolBtn = document.getElementById('saveProtocolBtn');
            
            this.dom.newPatientModal = document.getElementById('newPatientModal');
            this.dom.closeNewPatientModal = document.getElementById('closeNewPatientModal');
            this.dom.newPatientId = document.getElementById('newPatientId');
            this.dom.newTxDate = document.getElementById('newTxDate');
            this.dom.newPatientBaseline = document.getElementById('newPatientBaseline');
            this.dom.cancelNewPatientBtn = document.getElementById('cancelNewPatientBtn');
            this.dom.createPatientBtn = document.getElementById('createPatientBtn');
            
            this.dom.patientListModal = document.getElementById('patientListModal');
            this.dom.closePatientListModal = document.getElementById('closePatientListModal');
            this.dom.patientList = document.getElementById('patientList');
            this.dom.addNewPatientBtn = document.getElementById('addNewPatientBtn');
            
            this.dom.baselineConfirmModal = document.getElementById('baselineConfirmModal');
            this.dom.closeBaselineConfirmModal = document.getElementById('closeBaselineConfirmModal');
            this.dom.previousBaselineValue = document.getElementById('previousBaselineValue');
            this.dom.previousBaselineDate = document.getElementById('previousBaselineDate');
            this.dom.newBaselineValue = document.getElementById('newBaselineValue');
            this.dom.newBaselineDate = document.getElementById('newBaselineDate');
            this.dom.cancelBaselineChangeBtn = document.getElementById('cancelBaselineChangeBtn');
            this.dom.keepOldBaselineBtn = document.getElementById('keepOldBaselineBtn');
            this.dom.updateAllBaselineBtn = document.getElementById('updateAllBaselineBtn');
            
            this.dom.duplicateDateModal = document.getElementById('duplicateDateModal');
            this.dom.closeDuplicateModal = document.getElementById('closeDuplicateModal');
            this.dom.duplicateDateMessage = document.getElementById('duplicateDateMessage');
            this.dom.cancelDuplicateBtn = document.getElementById('cancelDuplicateBtn');
            this.dom.addAsNewBtn = document.getElementById('addAsNewBtn');
            this.dom.replaceExistingBtn = document.getElementById('replaceExistingBtn');
            
            // Toast container
            this.dom.toastContainer = document.getElementById('toastContainer');
        }
        
        setupEventListeners() {
            // Navigation
            this.dom.navBtns.forEach(btn => {
                btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
            });
            
            // Header actions
            this.dom.protocolSettingsBtn.addEventListener('click', () => this.showModal('protocolModal'));
            this.dom.exportBtn.addEventListener('click', () => this.exportAllData());
            
            // Patient actions
            this.dom.newPatientBtn.addEventListener('click', () => this.showModal('newPatientModal'));
            this.dom.patientListBtn.addEventListener('click', () => this.showPatientList());
            
            // Quick mode - Real-time validation
            this.dom.inputFev1.addEventListener('input', (e) => {
                this.validateRealTime(e.target, 'fev1');
                this.handleQuickInput();
            });
            
            this.dom.inputFvc.addEventListener('input', (e) => {
                this.validateRealTime(e.target, 'fvc');
                this.handleQuickInput();
            });
            
            // Quick actions
            this.dom.clearQuickBtn.addEventListener('click', () => this.clearQuickCalc());
            this.dom.saveQuickBtn.addEventListener('click', () => this.saveQuickVisit());
            
            // Monitor mode - Baseline control
            this.dom.manualBaselineInput.addEventListener('input', (e) => {
                this.validateRealTime(e.target, 'baseline');
            });
            
            this.dom.setBaselineBtn.addEventListener('click', () => this.setManualBaseline());
            
            // Monitor mode - View toggle
            this.dom.viewToggleBtns.forEach(btn => {
                btn.addEventListener('click', () => this.switchMonitorView(btn.dataset.view));
            });
            
            // Monitor mode - Date validation
            this.dom.visitDate.addEventListener('change', () => this.checkDateValidity());
            this.dom.addVisitBtn.addEventListener('click', () => this.addVisit());
            
            // Settings mode
            this.dom.exportAllDataBtn.addEventListener('click', () => this.exportAllData());
            this.dom.clearAllDataBtn.addEventListener('click', () => this.clearAllData());
            this.dom.colorCodingToggle.addEventListener('change', () => this.toggleColorCoding());
            this.dom.autoSaveToggle.addEventListener('change', () => this.toggleAutoSave());
            
            // Protocol modal
            this.dom.closeProtocolModal.addEventListener('click', () => this.hideModal('protocolModal'));
            this.dom.resetProtocolBtn.addEventListener('click', () => this.resetProtocol());
            this.dom.saveProtocolBtn.addEventListener('click', () => this.saveProtocol());
            
            // New patient modal
            this.dom.closeNewPatientModal.addEventListener('click', () => this.hideModal('newPatientModal'));
            this.dom.cancelNewPatientBtn.addEventListener('click', () => this.hideModal('newPatientModal'));
            this.dom.createPatientBtn.addEventListener('click', () => this.createPatient());
            
            // Patient list modal
            this.dom.closePatientListModal.addEventListener('click', () => this.hideModal('patientListModal'));
            this.dom.addNewPatientBtn.addEventListener('click', () => {
                this.hideModal('patientListModal');
                this.showModal('newPatientModal');
            });
            
            // Baseline confirmation modal
            this.dom.closeBaselineConfirmModal.addEventListener('click', () => this.hideModal('baselineConfirmModal'));
            this.dom.cancelBaselineChangeBtn.addEventListener('click', () => this.hideModal('baselineConfirmModal'));
            this.dom.keepOldBaselineBtn.addEventListener('click', () => this.handleBaselineChange('keep'));
            this.dom.updateAllBaselineBtn.addEventListener('click', () => this.handleBaselineChange('update'));
            
            // Duplicate date modal
            this.dom.closeDuplicateModal.addEventListener('click', () => this.hideModal('duplicateDateModal'));
            this.dom.cancelDuplicateBtn.addEventListener('click', () => this.hideModal('duplicateDateModal'));
            this.dom.addAsNewBtn.addEventListener('click', () => this.handleDuplicateAddAsNew());
            this.dom.replaceExistingBtn.addEventListener('click', () => this.handleDuplicateReplace());
            
            // Modal close on overlay click
            [this.dom.protocolModal, this.dom.newPatientModal, this.dom.patientListModal, 
             this.dom.baselineConfirmModal, this.dom.duplicateDateModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) this.hideModal(modal.id);
                });
            });
            
            // PDF export
            this.dom.exportPDFBtn.addEventListener('click', () => this.exportProfessionalPDF());
            
            // Auto-save on page unload
            window.addEventListener('beforeunload', (e) => {
                if (this.state.settings.autoSave) {
                    this.saveState();
                }
            });
        }
        
        // ===== DATE VALIDATION =====
        
        checkDateValidity() {
            const dateInput = this.dom.visitDate;
            const date = new Date(dateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (!this.state.currentPatient) {
                this.showDateWarning('Please select a patient first', 'error');
                return false;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient || !patient.txDate) {
                this.showDateWarning('Patient has no transplant date', 'error');
                return false;
            }
            
            const txDate = new Date(patient.txDate);
            
            // Check future date
            if (date > today) {
                this.showDateWarning('Date cannot be in future', 'error');
                dateInput.classList.add('invalid');
                return false;
            }
            
            // Check before transplant date
            if (date < txDate) {
                this.showDateWarning('Date is before transplant date', 'error');
                dateInput.classList.add('invalid');
                return false;
            }
            
            // Check duplicate date
            if (patient.visits.some(v => v.date === dateInput.value)) {
                this.showDateWarning('Visit already exists for this date', 'warning');
                dateInput.classList.add('invalid');
                return false;
            }
            
            // Check interval warnings
            if (patient.visits.length > 0) {
                const lastVisit = patient.visits[patient.visits.length - 1];
                const lastDate = new Date(lastVisit.date);
                const daysDiff = Math.floor((date - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff < 7) {
                    this.showDateWarning('Visits too frequent (<7 days)', 'warning');
                } else if (daysDiff > 90) {
                    this.showDateWarning('Long interval (>90 days)', 'warning');
                }
            }
            
            dateInput.classList.remove('invalid');
            this.dom.dateIntervalWarning.classList.add('hidden');
            return true;
        }
        
        showDateWarning(message, type) {
            this.dom.dateIntervalWarning.textContent = message;
            this.dom.dateIntervalWarning.className = `date-warning ${type}`;
            this.dom.dateIntervalWarning.classList.remove('hidden');
        }
        
        // ===== VALIDATION =====
        
        validateRealTime(input, type) {
            const value = parseFloat(input.value);
            let message = '';
            let messageType = '';
            
            if (!input.value.trim()) {
                this.clearValidation(type);
                return true;
            }
            
            if (isNaN(value)) {
                message = 'Please enter a valid number';
                messageType = 'error';
            } else {
                switch(type) {
                    case 'fev1':
                        if (value < 0.5) {
                            message = 'Below physiological minimum (0.5 L)';
                            messageType = 'error';
                        } else if (value > 8.0) {
                            message = 'Above physiological maximum (8.0 L)';
                            messageType = 'error';
                        } else {
                            message = 'Valid FEV measurement';
                            messageType = 'success';
                        }
                        break;
                        
                    case 'fvc':
                        if (value < 0.5) {
                            message = 'Below physiological minimum (0.5 L)';
                            messageType = 'error';
                        } else if (value > 10.0) {
                            message = 'Above physiological maximum (10.0 L)';
                            messageType = 'error';
                        } else {
                            // Check FVC > FEV if FEV is entered
                            const fev1 = parseFloat(this.dom.inputFev1.value);
                            if (!isNaN(fev1) && value < fev1) {
                                message = 'Warning: FVC should be greater than FEV';
                                messageType = 'warning';
                            } else {
                                message = 'Valid FVC measurement';
                                messageType = 'success';
                            }
                        }
                        break;
                        
                    case 'baseline':
                        if (value < 0.5) {
                            message = 'Below physiological minimum (0.5 L)';
                            messageType = 'error';
                        } else if (value > 8.0) {
                            message = 'Above physiological maximum (8.0 L)';
                            messageType = 'error';
                        } else {
                            message = 'Valid baseline';
                            messageType = 'success';
                        }
                        break;
                }
            }
            
            this.showValidation(type, message, messageType);
            return messageType !== 'error';
        }
        
        showValidation(type, message, messageType) {
            const validationEl = document.getElementById(`${type}Validation`);
            if (validationEl) {
                validationEl.textContent = message;
                validationEl.className = `validation-message ${messageType}`;
            }
        }
        
        clearValidation(type) {
            const validationEl = document.getElementById(`${type}Validation`);
            if (validationEl) {
                validationEl.textContent = '';
                validationEl.className = 'validation-message';
            }
        }
        
        // ===== STATE MANAGEMENT =====
        
        async loadState() {
            try {
                const saved = localStorage.getItem('spirolite_v1.4');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    if (data.settings) {
                        this.state.settings = { ...this.state.settings, ...data.settings };
                        this.updateSettingsUI();
                    }
                    
                    if (data.patients && Array.isArray(data.patients)) {
                        data.patients.forEach(patient => {
                            this.state.patients.set(patient.id, patient);
                        });
                    }
                    
                    if (data.currentPatient && this.state.patients.has(data.currentPatient)) {
                        this.state.currentPatient = data.currentPatient;
                        this.updatePatientContext();
                    }
                    
                    this.showToast('App state loaded successfully', 'success');
                }
            } catch (error) {
                console.error('Failed to load state:', error);
                this.showToast('Starting with fresh state', 'warning');
            }
        }
        
        saveState() {
            try {
                const data = {
                    settings: this.state.settings,
                    patients: Array.from(this.state.patients.values()),
                    currentPatient: this.state.currentPatient,
                    version: '1.4.0',
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem('spirolite_v1.4', JSON.stringify(data));
            } catch (error) {
                console.error('Failed to save state:', error);
                this.showToast('Failed to save data', 'error');
            }
        }
        
        updateUI() {
            this.updateSettingsUI();
            this.updatePatientContext();
            
            const today = new Date().toISOString().split('T')[0];
            this.dom.newTxDate.value = today;
            this.dom.newTxDate.max = today;
            this.dom.visitDate.value = today;
            this.dom.visitDate.min = '2000-01-01';
            this.dom.visitDate.max = today;
            
            setTimeout(() => this.dom.inputFev1.focus(), 100);
        }
        
        updateSettingsUI() {
            this.dom.monitorThreshold.value = this.state.settings.monitorThreshold;
            this.dom.reviewThreshold.value = this.state.settings.reviewThreshold;
            this.dom.colorCodingToggle.checked = this.state.settings.colorCoding;
            this.dom.autoSaveToggle.checked = this.state.settings.autoSave;
        }
        
        // ===== PATIENT MANAGEMENT =====
        
        createPatient() {
            const id = this.dom.newPatientId.value.trim().toUpperCase();
            const txDate = this.dom.newTxDate.value;
            const baseline = this.dom.newPatientBaseline.value ? parseFloat(this.dom.newPatientBaseline.value) : null;
            
            if (!id) {
                this.showToast('Please enter Patient ID', 'error');
                return;
            }
            
            if (!txDate) {
                this.showToast('Please enter transplant date', 'error');
                return;
            }
            
            if (this.state.patients.has(id)) {
                this.showToast(`Patient ${id} already exists`, 'error');
                return;
            }
            
            // Validate transplant date not in future
            const today = new Date().toISOString().split('T')[0];
            if (txDate > today) {
                this.showToast('Transplant date cannot be in future', 'error');
                return;
            }
            
            const patient = {
                id,
                txDate,
                baselineFev1: baseline,
                baselineDate: baseline ? today : null,
                visits: [],
                baselineHistory: baseline ? [{
                    value: baseline,
                    date: today,
                    method: 'initial',
                    recordedAt: new Date().toISOString()
                }] : [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            this.state.patients.set(id, patient);
            this.setCurrentPatient(id);
            
            this.hideModal('newPatientModal');
            this.saveState();
            
            this.showToast(`Patient created: ${id}`, 'success');
            
            // Reset form
            this.dom.newPatientId.value = '';
            this.dom.newTxDate.value = '';
            this.dom.newPatientBaseline.value = '';
        }
        
        showPatientList() {
            this.dom.patientList.innerHTML = '';
            
            if (this.state.patients.size === 0) {
                this.dom.patientList.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-4); text-align: center; color: var(--text-tertiary);">
                        <div style="font-size: 2rem; margin-bottom: var(--space-2);"></div>
                        <p>No patients yet</p>
                        <p class="notes-hint mt-2">Create your first patient to get started</p>
                    </div>
                `;
            } else {
                this.state.patients.forEach(patient => {
                    const lastVisit = patient.visits.length > 0 
                        ? patient.visits[patient.visits.length - 1] 
                        : null;
                    
                    const card = document.createElement('div');
                    card.className = `milestone ${patient.id === this.state.currentPatient ? 'active' : ''}`;
                    card.style.cursor = 'pointer';
                    card.style.marginBottom = 'var(--space-2)';
                    card.style.padding = 'var(--space-2)';
                    card.style.borderRadius = 'var(--radius-md)';
                    card.style.background = patient.id === this.state.currentPatient ? 'rgba(26, 95, 122, 0.1)' : 'rgba(255, 255, 255, 0.5)';
                    card.style.border = `1px solid ${patient.id === this.state.currentPatient ? 'var(--primary)' : 'var(--glass-border)'}`;
                    card.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--primary);">${patient.id}</div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary);">
                                Tx: ${new Date(patient.txDate).toLocaleDateString()}  ${patient.visits.length} visits
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-2); align-items: center;">
                            ${lastVisit ? `<div style="font-weight: 600; color: var(--primary); font-size: 0.75rem;">${lastVisit.fev1.toFixed(2)} L</div>` : ''}
                        </div>
                    `;
                    
                    // Select patient
                    card.addEventListener('click', () => {
                        this.setCurrentPatient(patient.id);
                        this.hideModal('patientListModal');
                    });
                    
                    this.dom.patientList.appendChild(card);
                });
            }
            
            this.showModal('patientListModal');
        }
        
        setCurrentPatient(patientId) {
            this.clearSessionData();
            
            this.state.currentPatient = patientId;
            this.updatePatientContext();
            
            this.dom.quickPatientBadge.textContent = patientId;
            this.dom.monitorPatientBadge.textContent = patientId;
            
            const patient = this.state.patients.get(patientId);
            if (patient) {
                // Update baseline input
                if (patient.baselineFev1) {
                    this.dom.manualBaselineInput.value = patient.baselineFev1.toFixed(2);
                    this.dom.currentBaselineValue.textContent = `${patient.baselineFev1.toFixed(2)} L`;
                    this.dom.currentBaselineValue.style.display = 'block';
                    this.dom.manualBaselineInput.style.display = 'none';
                } else {
                    this.dom.manualBaselineInput.value = '';
                    this.dom.currentBaselineValue.style.display = 'none';
                    this.dom.manualBaselineInput.style.display = 'block';
                }
                
                this.updateVisitsTable();
                
                // Set min date for visit date input
                this.dom.visitDate.min = patient.txDate;
            }
            
            this.showToast(`Now working with ${patientId}`, 'success');
        }
        
        clearSessionData() {
            // Clear quick mode
            this.dom.inputFev1.value = '';
            this.dom.inputFvc.value = '';
            this.dom.resultsPanel.classList.remove('visible');
            
            this.state.session.quick.fev1 = null;
            this.state.session.quick.fvc = null;
            
            // Update charts
            if (this.state.session.timelineChart) {
                this.updateTimelineChart();
            }
        }
        
        updatePatientContext() {
            if (!this.state.currentPatient) {
                this.dom.patientAvatar.textContent = '--';
                this.dom.patientIdDisplay.textContent = 'No Patient';
                this.dom.txDateStatus.textContent = ' No Tx Date';
                this.dom.txDateStatus.className = 'tx-date-status missing';
                this.dom.patientTxDateDisplay.textContent = '--';
                this.dom.visitsCountCompact.textContent = '0 visits';
                this.dom.currentBaselineDisplay.textContent = 'No baseline';
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            this.dom.patientAvatar.textContent = patient.id.substring(0, 2);
            this.dom.patientIdDisplay.textContent = patient.id;
            
            // Update transplant date status
            const txDate = new Date(patient.txDate);
            const today = new Date();
            const daysSinceTx = Math.floor((today - txDate) / (1000 * 60 * 60 * 24));
            
            let status = 'missing';
            let statusText = ' Missing';
            
            if (daysSinceTx < 0) {
                status = 'missing';
                statusText = ' Invalid (future)';
            } else if (daysSinceTx <= 30) {
                status = 'recent';
                statusText = ' Recent (<30d)';
            } else {
                status = 'valid';
                statusText = ' Valid';
            }
            
            this.dom.txDateStatus.textContent = statusText;
            this.dom.txDateStatus.className = `tx-date-status ${status}`;
            
            // Format date display
            const years = (daysSinceTx / 365.25).toFixed(1);
            this.dom.patientTxDateDisplay.textContent = 
                `${txDate.toLocaleDateString()} (${years}y)`;
            
            // Update visits count
            this.dom.visitsCountCompact.textContent = `${patient.visits.length} visit${patient.visits.length !== 1 ? 's' : ''}`;
            
            // Update baseline display
            if (patient.baselineFev1) {
                this.dom.currentBaselineDisplay.textContent = `${patient.baselineFev1.toFixed(2)} L`;
                if (patient.visits.length > 0) {
                    const lastVisit = patient.visits[patient.visits.length - 1];
                    const percent = (lastVisit.fev1 / patient.baselineFev1 * 100).toFixed(0);
                    this.dom.currentBaselineDisplay.textContent = `${percent}% of baseline`;
                }
            } else {
                this.dom.currentBaselineDisplay.textContent = 'No baseline';
            }
        }
        
        // ===== QUICK CALCULATION MODE =====
        
        handleQuickInput() {
            const fev1 = parseFloat(this.dom.inputFev1.value);
            const fvc = this.dom.inputFvc.value ? parseFloat(this.dom.inputFvc.value) : null;
            
            if (isNaN(fev1) || fev1 < 0.5 || fev1 > 8.0) {
                this.state.session.quick.fev1 = null;
                this.state.session.quick.fvc = null;
                this.dom.resultsPanel.classList.remove('visible');
                return;
            }
            
            this.state.session.quick.fev1 = fev1;
            this.state.session.quick.fvc = fvc;
            
            this.calculateQuick();
        }
        
        calculateQuick() {
            if (!this.state.session.quick.fev1) {
                this.dom.resultsPanel.classList.remove('visible');
                return;
            }
            
            const fev1 = this.state.session.quick.fev1;
            const fvc = this.state.session.quick.fvc;
            
            // Update basic results
            this.dom.resultFev1Liters.textContent = fev1.toFixed(2);
            this.dom.resultFvc.textContent = fvc ? fvc.toFixed(2) : '--';
            
            // Calculate ratio if FVC is provided
            let ratio = '--';
            if (fvc && fvc > 0) {
                const ratioValue = (fev1 / fvc) * 100;
                ratio = ratioValue.toFixed(1) + '%';
            }
            this.dom.resultRatio.textContent = ratio;
            
            // Get comparison data
            let lastVisitValue = null;
            let baselineValue = null;
            
            if (this.state.currentPatient) {
                const patient = this.state.patients.get(this.state.currentPatient);
                if (patient) {
                    if (patient.visits.length > 0) {
                        const lastVisit = patient.visits[patient.visits.length - 1];
                        lastVisitValue = lastVisit.fev1;
                    }
                    baselineValue = patient.baselineFev1;
                }
            }
            
            // Calculate percentages and changes
            let baselinePercent = null;
            let baselineDelta = null;
            let visitDelta = null;
            let visitPercent = null;
            
            if (baselineValue) {
                baselinePercent = (fev1 / baselineValue) * 100;
                baselineDelta = fev1 - baselineValue;
            }
            
            if (lastVisitValue) {
                visitDelta = fev1 - lastVisitValue;
                visitPercent = lastVisitValue > 0 ? ((fev1 - lastVisitValue) / lastVisitValue) * 100 : 0;
            }
            
            // Determine FEV1 percentage category
            let baselineCategory = 'neutral';
            if (baselinePercent !== null) {
                if (baselinePercent >= (100 - this.state.settings.monitorThreshold)) {
                    baselineCategory = 'good';
                } else if (baselinePercent >= (100 - this.state.settings.reviewThreshold)) {
                    baselineCategory = 'warning';
                } else {
                    baselineCategory = 'alert';
                }
            }
            
            // Apply color coding if enabled
            if (!this.state.settings.colorCoding) {
                baselineCategory = 'neutral';
            }
            
            // Update FEV1 percentage display
            if (baselinePercent !== null) {
                this.dom.resultFev1Percent.textContent = `${baselinePercent.toFixed(0)}%`;
                this.dom.resultFev1Percent.className = `percent-display ${baselineCategory}`;
            } else {
                this.dom.resultFev1Percent.textContent = `${fev1.toFixed(2)} L`;
                this.dom.resultFev1Percent.className = `percent-display neutral`;
            }
            
            // Update comparison results
            if (baselineValue || lastVisitValue) {
                this.dom.comparisonResults.classList.remove('hidden');
                
                // Update visit comparison
                if (lastVisitValue !== null) {
                    const changeClass = visitDelta > 0 ? 'positive' : (visitDelta < 0 ? 'negative' : 'neutral');
                    this.dom.resultVisitDelta.textContent = `${visitDelta >= 0 ? '+' : ''}${visitDelta.toFixed(2)}`;
                    this.dom.resultVisitDelta.className = `metric-value visit-change ${changeClass}`;
                    this.dom.resultVisitPercent.textContent = `${visitPercent >= 0 ? '+' : ''}${visitPercent.toFixed(1)}%`;
                } else {
                    this.dom.resultVisitDelta.textContent = '--';
                    this.dom.resultVisitDelta.className = 'metric-value visit-change neutral';
                    this.dom.resultVisitPercent.textContent = '--%';
                }
                
                // Update baseline comparison
                if (baselineValue !== null) {
                    this.dom.resultBaselinePercent.textContent = `${baselinePercent.toFixed(1)}%`;
                    this.dom.resultBaselinePercent.className = `metric-value baseline-percent ${baselineCategory}`;
                    this.dom.resultBaselineDelta.textContent = `${baselineDelta >= 0 ? '+' : ''}${baselineDelta.toFixed(2)} L`;
                } else {
                    this.dom.resultBaselinePercent.textContent = '--%';
                    this.dom.resultBaselinePercent.className = 'metric-value baseline-percent neutral';
                    this.dom.resultBaselineDelta.textContent = '-- L';
                }
            } else {
                this.dom.comparisonResults.classList.add('hidden');
            }
            
            // Update time context
            if (this.state.currentPatient) {
                const patient = this.state.patients.get(this.state.currentPatient);
                if (patient && patient.txDate) {
                    const txDate = new Date(patient.txDate);
                    const today = new Date();
                    const daysPostTx = Math.floor((today - txDate) / (1000 * 60 * 60 * 24));
                    const yearsPostTx = (daysPostTx / 365.25).toFixed(1);
                    
                    this.dom.daysPostTx.textContent = daysPostTx;
                    this.dom.yearsPostTx.textContent = `${yearsPostTx}y`;
                    
                    // Calculate time since last visit
                    let daysSinceLast = '--';
                    let rateOfChange = '--';
                    
                    if (patient.visits.length > 0) {
                        const lastVisit = patient.visits[patient.visits.length - 1];
                        const lastDate = new Date(lastVisit.date);
                        daysSinceLast = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                        
                        // Calculate monthly rate
                        if (visitDelta !== null && daysSinceLast > 0) {
                            const monthsSinceLast = daysSinceLast / 30.44;
                            rateOfChange = (visitDelta / monthsSinceLast).toFixed(3);
                        }
                    }
                    
                    this.dom.daysSinceLast.textContent = daysSinceLast;
                    this.dom.rateOfChange.textContent = rateOfChange;
                    this.dom.timeContext.classList.remove('hidden');
                } else {
                    this.dom.timeContext.classList.add('hidden');
                }
            } else {
                this.dom.timeContext.classList.add('hidden');
            }
            
            // Update timestamp
            const now = new Date();
            this.dom.resultsTimestamp.textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            
            this.dom.resultsPanel.classList.add('visible');
        }
        
        clearQuickCalc() {
            this.dom.inputFev1.value = '';
            this.dom.inputFvc.value = '';
            this.dom.resultsPanel.classList.remove('visible');
            
            this.state.session.quick.fev1 = null;
            this.state.session.quick.fvc = null;
            
            this.dom.inputFev1.focus();
            this.showToast('Cleared', 'info');
        }
        
        saveQuickVisit() {
            if (!this.state.session.quick.fev1) {
                this.showToast('Please enter FEV measurement first', 'error');
                return;
            }
            
            if (!this.state.currentPatient) {
                this.showToast('Please select a patient first', 'error');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) {
                this.showToast('Patient not found', 'error');
                return;
            }
            
            if (!patient.txDate) {
                this.showToast('Patient has no transplant date', 'error');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const fev1 = this.state.session.quick.fev1;
            const fvc = this.state.session.quick.fvc;
            
            // Check if visit date is after transplant date
            if (today < patient.txDate) {
                this.showToast('Visit date cannot be before transplant date', 'error');
                return;
            }
            
            // Check for duplicate date
            const existingVisitIndex = patient.visits.findIndex(v => v.date === today);
            
            if (existingVisitIndex !== -1) {
                // Show duplicate date modal
                this.showDuplicateDateModal(today, existingVisitIndex, { fev1, fvc });
                return;
            }
            
            // Add new visit
            const visit = {
                date: today,
                fev1,
                fvc,
                recordedAt: new Date().toISOString()
            };
            
            patient.visits.push(visit);
            patient.updatedAt = new Date().toISOString();
            
            this.state.patients.set(patient.id, patient);
            this.saveState();
            
            this.updatePatientContext();
            this.updateVisitsTable();
            this.showToast(`Visit saved: ${patient.id}: ${fev1.toFixed(2)} L`, 'success');
            
            // Clear quick calc after saving
            this.clearQuickCalc();
        }
        
        // ===== MONITOR MODE =====
        
        addVisit() {
            if (!this.checkDateValidity()) {
                this.showToast('Please check date selection', 'error');
                return;
            }
            
            const date = this.dom.visitDate.value;
            const fev1 = parseFloat(this.dom.visitFev1.value);
            const fvc = this.dom.visitFvc.value ? parseFloat(this.dom.visitFvc.value) : null;
            
            if (!date || !fev1 || isNaN(fev1) || fev1 < 0.5 || fev1 > 8.0) {
                this.showToast('Please enter valid date and FEV measurement', 'error');
                return;
            }
            
            if (fvc && (isNaN(fvc) || fvc < 0.5 || fvc > 10.0)) {
                this.showToast('Please enter valid FVC measurement', 'error');
                return;
            }
            
            if (!this.state.currentPatient) {
                this.showToast('Please select a patient first', 'error');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) {
                this.showToast('Patient not found', 'error');
                return;
            }
            
            // Check for duplicate date
            const existingVisitIndex = patient.visits.findIndex(v => v.date === date);
            
            if (existingVisitIndex !== -1) {
                this.showDuplicateDateModal(date, existingVisitIndex, { fev1, fvc });
                return;
            }
            
            // Add visit
            const visit = {
                date,
                fev1,
                fvc,
                recordedAt: new Date().toISOString()
            };
            
            patient.visits.push(visit);
            patient.updatedAt = new Date().toISOString();
            
            this.state.patients.set(patient.id, patient);
            this.saveState();
            
            this.updateVisitsTable();
            this.updatePatientContext();
            
            // Clear form
            this.dom.visitFev1.value = '';
            this.dom.visitFvc.value = '';
            this.dom.visitFev1.focus();
            
            this.showToast(`Visit saved: ${date} - ${fev1.toFixed(2)} L`, 'success');
        }
        
        setManualBaseline() {
            const value = parseFloat(this.dom.manualBaselineInput.value);
            
            if (!value || isNaN(value) || value < 0.5 || value > 8.0) {
                this.showToast('Please enter a valid baseline FEV', 'error');
                return;
            }
            
            if (!this.state.currentPatient) {
                this.showToast('Please select a patient first', 'error');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) {
                this.showToast('Patient not found', 'error');
                return;
            }
            
            // If patient already has a baseline, show confirmation modal
            if (patient.baselineFev1) {
                this.showBaselineConfirmModal(patient.baselineFev1, value);
                return;
            }
            
            // Set new baseline
            this.updatePatientBaseline(value);
        }
        
        showBaselineConfirmModal(previousValue, newValue) {
            this.dom.previousBaselineValue.textContent = `${previousValue.toFixed(2)} L`;
            this.dom.newBaselineValue.textContent = `${newValue.toFixed(2)} L`;
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (patient) {
                this.dom.previousBaselineDate.textContent = patient.baselineDate || 'Unknown date';
                this.dom.newBaselineDate.textContent = new Date().toISOString().split('T')[0];
            }
            
            this.showModal('baselineConfirmModal');
        }
        
        handleBaselineChange(action) {
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            const newValue = parseFloat(this.dom.manualBaselineInput.value);
            
            if (action === 'update') {
                this.updatePatientBaseline(newValue);
            }
            
            this.hideModal('baselineConfirmModal');
        }
        
        updatePatientBaseline(value) {
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            const previousBaseline = patient.baselineFev1;
            patient.baselineFev1 = value;
            patient.baselineDate = new Date().toISOString().split('T')[0];
            
            patient.baselineHistory.push({
                value,
                date: patient.baselineDate,
                method: 'manual_set',
                previousValue: previousBaseline,
                recordedAt: new Date().toISOString(),
                notes: 'Manually set baseline'
            });
            
            patient.updatedAt = new Date().toISOString();
            this.state.patients.set(patient.id, patient);
            
            this.saveState();
            this.updatePatientContext();
            this.updateVisitsTable();
            
            this.showToast(`Baseline set: ${value.toFixed(2)} L`, 'success');
            
            // Update UI
            this.dom.currentBaselineValue.textContent = `${value.toFixed(2)} L`;
            this.dom.currentBaselineValue.style.display = 'block';
            this.dom.manualBaselineInput.style.display = 'none';
        }
        
        // ===== VISITS TABLE =====
        
        updateVisitsTable() {
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) {
                this.dom.visitsTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center" style="padding: var(--space-4); color: var(--text-tertiary);">
                                            No patient selected
                                        </td>
                                    </tr>
                                `;
                return;
            }
            
            const visits = patient.visits;
            
            if (visits.length === 0) {
                this.dom.visitsTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center" style="padding: var(--space-4); color: var(--text-tertiary);">
                            No visits yet. Add visits using the form above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort visits by date
            const sortedVisits = [...visits].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Generate table rows
            this.dom.visitsTableBody.innerHTML = '';
            
            sortedVisits.forEach((visit, index) => {
                const date = new Date(visit.date);
                const txDate = new Date(patient.txDate);
                const daysFromTx = Math.floor((date - txDate) / (1000 * 60 * 60 * 24));
                const prevVisit = index > 0 ? sortedVisits[index - 1] : null;
                
                // Calculate metrics
                const ratio = visit.fvc ? (visit.fev1 / visit.fvc * 100).toFixed(1) + '%' : '--';
                const visitDelta = prevVisit ? (visit.fev1 - prevVisit.fev1) : 0;
                const visitDeltaStr = prevVisit ? `${visitDelta >= 0 ? '+' : ''}${visitDelta.toFixed(2)}` : '--';
                const visitPercent = prevVisit ? ((visitDelta / prevVisit.fev1) * 100).toFixed(1) : '--';
                
                const baselineDelta = patient.baselineFev1 ? (visit.fev1 - patient.baselineFev1) : 0;
                const baselineDeltaStr = patient.baselineFev1 ? `${baselineDelta >= 0 ? '+' : ''}${baselineDelta.toFixed(2)}` : '--';
                const baselinePercent = patient.baselineFev1 ? ((visit.fev1 / patient.baselineFev1) * 100) : null;
                
                // Calculate monthly rate
                let monthlyRate = '--';
                if (prevVisit) {
                    const prevDate = new Date(prevVisit.date);
                    const daysDiff = Math.floor((date - prevDate) / (1000 * 60 * 60 * 24));
                    const monthsDiff = daysDiff / 30.44;
                    if (monthsDiff > 0) {
                        monthlyRate = (visitDelta / monthsDiff).toFixed(3);
                    }
                }
                
                // Determine days since previous visit
                let daysSinceLast = '--';
                if (prevVisit) {
                    const prevDate = new Date(prevVisit.date);
                    daysSinceLast = Math.floor((date - prevDate) / (1000 * 60 * 60 * 24));
                }
                
                // Determine color classes
                const visitDeltaClass = visitDelta > 0 ? 'positive' : (visitDelta < 0 ? 'negative' : 'neutral');
                const baselinePercentClass = this.getBaselinePercentClass(baselinePercent);
                
                // Create row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td>${daysFromTx}</td>
                    <td>${visit.fev1.toFixed(2)}</td>
                    <td>
                        ${baselinePercent !== null ? `${baselinePercent.toFixed(1)}%` : '--'}
                    </td>
                    <td>${visit.fvc ? visit.fvc.toFixed(2) : '--'}</td>
                    <td>${ratio}</td>
                    <td class="${!this.state.settings.colorCoding ? '' : `visit-change ${visitDeltaClass}`}">
                        ${visitDeltaStr} (${visitPercent}%)
                    </td>
                    <td>${daysSinceLast}</td>
                    <td>${monthlyRate}</td>
                    <td>--</td>
                `;
                
                this.dom.visitsTableBody.appendChild(row);
            });
            
            // Update timeline chart if visible
            if (this.dom.timelineView.classList.contains('visible')) {
                if (!this.state.session.timelineChart) {
                    this.initTimelineChart();
                }
                this.updateTimelineChart();
            }
        }
        
        getBaselinePercentClass(percent) {
            if (!this.state.settings.colorCoding || percent === null) return 'neutral';
            if (percent >= (100 - this.state.settings.monitorThreshold)) return 'good';
            if (percent >= (100 - this.state.settings.reviewThreshold)) return 'warning';
            return 'alert';
        }
        
        // ===== CHART.JS FUNCTIONS =====
        
        initTimelineChart() {
            if (!this.dom.timelineChart) return;
            
            const ctx = this.dom.timelineChart.getContext('2d');
            this.state.session.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'FEV (L)',
                        data: [],
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim() || '#1A5F7A',
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-fill').trim() || 'rgba(26, 95, 122, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-point').trim() || '#2D9596',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 95, 122, 0.9)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                title: (context) => {
                                    return new Date(context[0].label).toLocaleDateString();
                                },
                                label: (context) => {
                                    return `FEV: ${context.parsed.y.toFixed(2)} L`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: { size: 9 },
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'var(--text-secondary)',
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toFixed(1) + ' L';
                                }
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });
        }
        
        updateTimelineChart() {
            const chart = this.state.session.timelineChart;
            if (!chart) return;
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient || patient.visits.length === 0) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
                return;
            }
            
            const sortedVisits = [...patient.visits].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            chart.data.labels = sortedVisits.map(v => v.date);
            chart.data.datasets[0].data = sortedVisits.map(v => v.fev1);
            
            chart.update();
        }
        
        // ===== MODE MANAGEMENT =====
        
        switchMode(mode) {
            this.state.mode = mode;
            
            this.dom.navBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            ['quick', 'monitor', 'settings'].forEach(m => {
                const el = document.getElementById(`mode${m.charAt(0).toUpperCase() + m.slice(1)}`);
                el.classList.toggle('active', m === mode);
            });
            
            if (mode === 'monitor') {
                this.updateVisitsTable();
                this.switchMonitorView('table');
            }
        }
        
        switchMonitorView(view) {
            this.dom.viewToggleBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            if (view === 'table') {
                this.dom.tableView.style.display = 'block';
                this.dom.timelineView.style.display = 'none';
            } else {
                this.dom.tableView.style.display = 'none';
                this.dom.timelineView.style.display = 'block';
                
                // Initialize timeline chart if needed
                if (!this.state.session.timelineChart) {
                    this.initTimelineChart();
                }
                this.updateTimelineChart();
            }
        }
        
        // ===== DUPLICATE DATE HANDLING =====
        
        showDuplicateDateModal(date, existingIndex, newVisit) {
            this.dom.duplicateDateMessage.textContent = 
                `Visit already exists for ${date}.`;
            
            this.showModal('duplicateDateModal');
            
            // Store data for later use
            this.state.session.duplicateDateData = {
                date,
                existingIndex,
                newVisit
            };
        }
        
        handleDuplicateAddAsNew() {
            const data = this.state.session.duplicateDateData;
            if (!data) return;
            
            // Add with modified date (add 1 day)
            const originalDate = new Date(data.date);
            originalDate.setDate(originalDate.getDate() + 1);
            const newDate = originalDate.toISOString().split('T')[0];
            
            this.addVisitWithDate(newDate, data.newVisit);
            this.hideModal('duplicateDateModal');
        }
        
        handleDuplicateReplace() {
            const data = this.state.session.duplicateDateData;
            if (!data) return;
            
            // Replace existing visit
            this.addVisitWithDate(data.date, data.newVisit, true);
            this.hideModal('duplicateDateModal');
        }
        
        addVisitWithDate(date, visitData, replace = false) {
            if (!this.state.currentPatient) return;
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient) return;
            
            const visit = {
                date,
                fev1: visitData.fev1,
                fvc: visitData.fvc,
                recordedAt: new Date().toISOString()
            };
            
            if (replace) {
                // Replace existing visit
                const existingIndex = patient.visits.findIndex(v => v.date === date);
                if (existingIndex !== -1) {
                    patient.visits[existingIndex] = visit;
                    this.showToast(`Visit replaced for ${date}: ${visit.fev1.toFixed(2)} L`, 'success');
                }
            } else {
                // Add as new visit
                patient.visits.push(visit);
                this.showToast(`Visit added for ${date}: ${visit.fev1.toFixed(2)} L`, 'success');
            }
            
            patient.updatedAt = new Date().toISOString();
            this.state.patients.set(patient.id, patient);
            this.saveState();
            
            this.updatePatientContext();
            this.updateVisitsTable();
        }
        
        // ===== PROTOCOL MANAGEMENT =====
        
        resetProtocol() {
            this.state.settings.monitorThreshold = 10;
            this.state.settings.reviewThreshold = 20;
            
            this.updateSettingsUI();
            this.showToast('Reset to defaults', 'info');
        }
        
        saveProtocol() {
            this.state.settings.monitorThreshold = parseInt(this.dom.monitorThreshold.value) || 10;
            this.state.settings.reviewThreshold = parseInt(this.dom.reviewThreshold.value) || 20;
            
            this.saveState();
            this.hideModal('protocolModal');
            
            this.updateVisitsTable();
            
            this.showToast('Protocol settings saved', 'success');
        }
        
        toggleColorCoding() {
            this.state.settings.colorCoding = this.dom.colorCodingToggle.checked;
            this.saveState();
            this.updateVisitsTable();
            this.showToast(this.state.settings.colorCoding ? 'Color coding enabled' : 'Color coding disabled', 'success');
        }
        
        toggleAutoSave() {
            this.state.settings.autoSave = this.dom.autoSaveToggle.checked;
            this.saveState();
            this.showToast(this.state.settings.autoSave ? 'Auto-save enabled' : 'Auto-save disabled', 'success');
        }
        
        // ===== MODAL MANAGEMENT =====
        
        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // ===== EXPORT FUNCTIONS =====
        
        exportAllData() {
            if (this.state.patients.size === 0) {
                this.showToast('No patient data to export', 'warning');
                return;
            }
            
            const data = {
                version: 'Spirolite v1.4',
                exportedAt: new Date().toISOString(),
                patients: Array.from(this.state.patients.values()),
                settings: this.state.settings
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spirolite_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showToast('All data exported as JSON backup', 'success');
        }
        
        exportProfessionalPDF() {
            if (!this.state.currentPatient) {
                this.showToast('Please select a patient first', 'warning');
                return;
            }
            
            const patient = this.state.patients.get(this.state.currentPatient);
            if (!patient || patient.visits.length === 0) {
                this.showToast('No visits to export', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const today = new Date();
            
            // ===== COVER PAGE =====
            doc.setFillColor(26, 95, 122);
            doc.rect(0, 0, 210, 297, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(32);
            doc.text('SPIROLITE', 105, 100, { align: 'center' });
            doc.setFontSize(18);
            doc.text('Medical Report', 105, 120, { align: 'center' });
            
            doc.setFontSize(14);
            doc.text(`Patient: ${patient.id}`, 105, 160, { align: 'center' });
            
            const txDate = new Date(patient.txDate);
            doc.text(`Transplant: ${txDate.toLocaleDateString()}`, 105, 170, { align: 'center' });
            
            doc.text(`Generated: ${today.toLocaleString()}`, 105, 180, { align: 'center' });
            
            doc.addPage();
            
            // ===== PATIENT SUMMARY =====
            doc.setFillColor(240, 240, 240);
            doc.rect(10, 10, 190, 40, 'F');
            doc.setTextColor(26, 95, 122);
            doc.setFontSize(16);
            doc.text('Patient Summary', 20, 25);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let yPos = 45;
            
            doc.text(`Patient: ${patient.id}`, 20, yPos);
            yPos += 8;
            
            doc.text(`Transplant: ${txDate.toLocaleDateString()}`, 20, yPos);
            yPos += 8;
            
            if (patient.baselineFev1) {
                doc.text(`Baseline FEV: ${patient.baselineFev1.toFixed(2)} L`, 20, yPos);
                yPos += 8;
            }
            
            doc.text(`Total Visits: ${patient.visits.length}`, 20, yPos);
            yPos += 8;
            
            if (patient.visits.length > 0) {
                const lastVisit = patient.visits[patient.visits.length - 1];
                const lastDate = new Date(lastVisit.date);
                const daysSpan = Math.floor((lastDate - txDate) / (1000 * 60 * 60 * 24));
                
                doc.text(`Days post-Tx: ${daysSpan} (${(daysSpan/365.25).toFixed(1)} years)`, 20, yPos);
                yPos += 8;
                
                if (patient.baselineFev1) {
                    const percent = (lastVisit.fev1 / patient.baselineFev1 * 100).toFixed(1);
                    doc.text(`Current Status: ${percent}% of baseline`, 20, yPos);
                    yPos += 8;
                }
            }
            
            yPos += 10;
            
            // ===== SUMMARY SECTION =====
            doc.setFillColor(26, 95, 122);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text('Summary', 20, yPos + 6);
            
            yPos += 15;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            
            if (patient.visits.length > 0 && patient.baselineFev1) {
                const lastVisit = patient.visits[patient.visits.length - 1];
                const percent = (lastVisit.fev1 / patient.baselineFev1 * 100).toFixed(1);
                
                doc.text(` Current FEV: ${lastVisit.fev1.toFixed(2)} L (${percent}% of baseline)`, 15, yPos);
                yPos += 6;
                
                // Trend analysis
                if (patient.visits.length > 1) {
                    const firstVisit = patient.visits[0];
                    const firstDate = new Date(firstVisit.date);
                    const lastDate = new Date(lastVisit.date);
                    const monthsDiff = (lastDate - firstDate) / (1000 * 60 * 60 * 24 * 30.44);
                    const trend = (lastVisit.fev1 - firstVisit.fev1) / monthsDiff;
                    
                    doc.text(` Trend: ${trend >= 0 ? '+' : ''}${trend.toFixed(2)} L/month`, 15, yPos);
                    yPos += 6;
                }
                
                // Status based on protocol
                if (parseFloat(percent) >= (100 - this.state.settings.monitorThreshold)) {
                    doc.text(' Status: Within normal range', 15, yPos);
                } else if (parseFloat(percent) >= (100 - this.state.settings.reviewThreshold)) {
                    doc.text(` Status: Monitor (${this.state.settings.monitorThreshold}% decline)`, 15, yPos);
                } else {
                    doc.text(` Status: Review required (${this.state.settings.reviewThreshold}% decline)`, 15, yPos);
                }
                yPos += 6;
            }
            
            yPos += 10;
            
            // ===== VISITS TABLE =====
            doc.setFillColor(26, 95, 122);
            doc.rect(10, yPos, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text('Visit History', 20, yPos + 6);
            
            const visits = [...patient.visits].sort((a, b) => new Date(a.date) - new Date(b.date));
            const tableData = visits.map((visit, index) => {
                const prevVisit = index > 0 ? visits[index - 1] : null;
                const visitDelta = prevVisit ? (visit.fev1 - prevVisit.fev1).toFixed(2) : '--';
                const baselineDelta = patient.baselineFev1 ? (visit.fev1 - patient.baselineFev1).toFixed(2) : '--';
                const baselinePercent = patient.baselineFev1 ? ((visit.fev1 / patient.baselineFev1) * 100).toFixed(1) : '--';
                
                return [
                    new Date(visit.date).toLocaleDateString(),
                    visit.fev1.toFixed(2),
                    baselinePercent + '%',
                    visit.fvc ? visit.fvc.toFixed(2) : '--',
                    visitDelta
                ];
            });
            
            doc.autoTable({
                head: [['Date', 'FEV (L)', '% of Baseline', 'FVC', ' from Last']],
                body: tableData,
                startY: yPos + 15,
                theme: 'grid',
                headStyles: { 
                    fillColor: [26, 95, 122],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 30 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 25 }
                }
            });
            
            // ===== FOOTER =====
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Generated by Spirolite v1.4 - Confidential Medical Document', 105, 285, { align: 'center' });
            
            // Save the PDF
            doc.save(`Spirolite_Report_${patient.id}_${today.toISOString().split('T')[0]}.pdf`);
            this.showToast('Professional PDF report exported', 'success');
        }
        
        clearAllData() {
            if (confirm(' DELETE ALL DATA?\n\nThis will permanently delete ALL patient records and visits. This action cannot be undone.')) {
                this.state.patients.clear();
                this.state.currentPatient = null;
                this.saveState();
                this.updatePatientContext();
                this.updateVisitsTable();
                this.showToast('All data cleared', 'success');
            }
        }
        
        // ===== TOAST NOTIFICATIONS =====
        
        showToast(message, type = 'info', duration = 3000) {
            const toastContainer = this.dom.toastContainer;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '' : 
                        type === 'error' ? '' : 
                        type === 'warning' ? '' : '';
            
            toast.innerHTML = `
                <div style="font-size: 0.875rem; display: flex; align-items: center; gap: var(--space-2);">
                    ${icon}
                    <span>${message}</span>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(30px)';
                setTimeout(() => {
                    if (toastContainer.contains(toast)) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
    }
    
    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        window.spiroliteApp = new SpiroliteApp();
        
        // Set current date as default for date inputs
        const today = new Date().toISOString().split('T')[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            if (!input.value) {
                input.value = today;
                input.max = today;
            }
        });
    });
    
    // Enhanced service worker registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js', { 
                scope: './',
                updateViaCache: 'none'
            })
            .then(registration => {
                console.log('SW registered: ', registration);
                
                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('SW update found');
                    
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New update available
                            if (confirm('A new version of Spirolite is available. Reload to update?')) {
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('SW registration failed: ', error);
            });
        });
    }
    </script>
</body>
</html>
