<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1E6EA6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Lung transplant calculation assistant with patient timeline tracking">
    
    <title>NeumoCalc | Patient Timeline Calculator</title>
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk5ldW1vQ2FsYyBUaW1lbGluZSIsCiAgInNob3J0X25hbWUiOiAiTmV1bW9DYWxjIiwKICAiZGVzY3JpcHRpb24iOiAiTHVuZyB0cmFuc3BsYW50IGNhbGN1bGF0aW9uIGFzc2lzdGFudCB3aXRoIHBhdGllbnQgdGltZWxpbmUgdHJhY2tpbmciLAogICJzdGFydF91cmwiOiAiLyIsCiAgInNjb3BlIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jb2xvciI6ICIjMUU2RUE2IiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJsYW5nIjogImVuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbi5zdmciLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInNpemVzIjogImFueSIKICAgIH0KICBdLAogICJjYXRlZ29yaWVzIjogWyJtZWRpY2FsIiwgInByb2R1Y3Rpdml0eSIsICJ1dGlsaXRpZXMiXQp9">
    
    <!-- App Icon (Embedded SVG) -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMxRTZFQTYiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMTU1NTg4Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1NiIgZmlsbD0idXJsKCNncmFkKSIvPgogIDxwYXRoIGQ9Ik0yMDAgMjAwIFExNTAgMjUwIDIwMCAzMDAgUTI1MCAzNTAgMjAwIDQwMCBNMzEyIDIwMCBRMzYyIDI1MCAzMTIgMzAwIFEyNjIgMzUwIDMxMiA0MDAgTTI1NiAyNDAgTDI1NiAzNjAgTTIwMCAyNTYgTDMxMiAyNTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgogIDxjaXJjbGUgY3g9IjI1NiIgY3k9IjI4MCIgcj0iOCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    
    <style>
        /* ===== RESET & BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: #f8fafc; color: #1f2937; line-height: 1.5;
            height: 100vh; height: -webkit-fill-available; overflow: hidden;
        }
        
        /* ===== APP CONTAINER ===== */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* ===== HEADER ===== */
        .app-header {
            background: white; padding: 1rem;
            padding-top: max(1rem, env(safe-area-inset-top));
            border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between;
            align-items: center; position: sticky; top: 0; z-index: 100;
        }
        
        .patient-header { display: flex; gap: 1rem; align-items: center; }
        .patient-id-display { font-family: monospace; font-weight: 700; color: #1E6EA6; font-size: 1.2rem; }
        .timeline-info { font-size: 0.875rem; color: #6b7280; }
        
        /* ===== MODE SELECTOR ===== */
        .mode-selector {
            display: flex; background: white; border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem; gap: 0.5rem; flex-shrink: 0;
        }
        
        .mode-btn {
            flex: 1; padding: 0.75rem; border: none; border-radius: 10px;
            background: #f9fafb; color: #6b7280; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        
        .mode-btn.active { background: #1E6EA6; color: white; box-shadow: 0 2px 8px rgba(30, 110, 166, 0.2); }
        
        /* ===== MAIN CONTENT ===== */
        .main-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1rem; }
        
        /* ===== PATIENT SELECTOR ===== */
        .patient-selector {
            background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;
            border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .patient-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem; margin-top: 1rem;
        }
        
        .patient-card {
            border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem;
            cursor: pointer; transition: all 0.2s; background: white;
        }
        
        .patient-card:hover { border-color: #1E6EA6; transform: translateY(-2px); }
        .patient-card.active { border-color: #1E6EA6; background: #f0f9ff; }
        
        .patient-id { font-weight: 600; color: #1E6EA6; }
        .patient-stats { font-size: 0.75rem; color: #6b7280; }
        
        /* ===== CALCULATOR ===== */
        .calc-container {
            background: white; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;
            border: 1px solid #e5e7eb; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .calc-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        
        .input-group { position: relative; }
        .input-label { font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .calc-input {
            width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 1.5rem; font-weight: 600; font-family: monospace; text-align: center;
            transition: all 0.2s; -moz-appearance: textfield;
        }
        
        .calc-input::-webkit-outer-spin-button,
        .calc-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .calc-input:focus { outline: none; border-color: #1E6EA6; box-shadow: 0 0 0 3px rgba(30, 110, 166, 0.1); }
        
        /* ===== RESULTS ===== */
        .results-container {
            background: white; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;
            border: 1px solid #e5e7eb; display: none;
        }
        
        .results-container.show { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .measurement-card {
            background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .timeline-row {
            display: flex; justify-content: space-between; padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .timeline-label { color: #4b5563; }
        .timeline-value { font-family: monospace; font-weight: 600; }
        
        .value-positive { color: #059669; }
        .value-negative { color: #dc2626; }
        .value-neutral { color: #6b7280; }
        
        /* ===== THRESHOLD INFO ===== */
        .threshold-info {
            background: #fef3c7; border-radius: 8px; padding: 1rem; margin-top: 1rem;
            border-left: 4px solid #f59e0b; animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .btn {
            flex: 1; padding: 1rem; border: none; border-radius: 10px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1E6EA6 0%, #155588 100%);
            color: white; box-shadow: 0 2px 8px rgba(30, 110, 166, 0.2);
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 110, 166, 0.3); }
        
        .btn-secondary {
            background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover { background: #e5e7eb; }
        
        /* ===== MODALS ===== */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; padding: 1rem;
        }
        
        .modal.show { display: flex; animation: fadeIn 0.3s ease; }
        
        .modal-content {
            background: white; border-radius: 16px; width: 100%;
            max-width: 400px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; }
        
        /* ===== PWA INSTALL BUTTON ===== */
        .install-btn {
            position: fixed; bottom: 20px; right: 20px; padding: 10px 20px;
            background: #1E6EA6; color: white; border: none; border-radius: 25px;
            font-weight: bold; z-index: 1000; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none;
        }
        
        /* ===== OFFLINE INDICATOR ===== */
        .offline-indicator {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: #f59e0b; color: #92400e; padding: 0.5rem 1rem;
            border-radius: 9999px; font-size: 0.75rem; font-weight: 600;
            z-index: 9999; display: none; animation: pulse 2s infinite;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 640px) {
            .calc-inputs { grid-template-columns: 1fr; }
            .patient-grid { grid-template-columns: repeat(2, 1fr); }
            .main-content { padding-left: max(1rem, env(safe-area-inset-left)); padding-right: max(1rem, env(safe-area-inset-right)); }
        }
        
        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="patient-header">
                <div class="patient-id-display" id="currentPatientId">No Patient Selected</div>
                <div class="timeline-info" id="timelineInfo"></div>
            </div>
            <div>
                <button class="btn-secondary" onclick="showNewPatientModal()">New Patient</button>
            </div>
        </header>
        
        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('quick')">‚ö° Quick Calc</button>
            <button class="mode-btn" onclick="switchMode('full')">üìã Full Patient</button>
            <button class="mode-btn" onclick="switchMode('review')">üìä Review All</button>
        </div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Calc Mode -->
            <div id="modeQuick">
                <div class="patient-selector">
                    <h3>Select Patient</h3>
                    <div class="patient-grid" id="patientGrid">
                        <!-- Patient cards will be inserted here -->
                    </div>
                </div>
                
                <div class="calc-container">
                    <h3>Quick Calculation</h3>
                    <div class="calc-inputs">
                        <div class="input-group">
                            <div class="input-label">FEV‚ÇÅ (L)</div>
                            <input type="number" step="0.01" min="0.5" max="8.0" 
                                   class="calc-input" id="quickFev1" placeholder="2.85" autofocus>
                        </div>
                        <div class="input-group">
                            <div class="input-label">FVC (L)</div>
                            <input type="number" step="0.01" min="0.5" max="10.0" 
                                   class="calc-input" id="quickFvc" placeholder="3.40">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-secondary" onclick="clearQuickInputs()">Clear</button>
                        <button class="btn-primary" onclick="calculateQuick()">Calculate</button>
                    </div>
                </div>
                
                <div class="results-container" id="quickResults">
                    <!-- Results will be inserted here -->
                </div>
            </div>
            
            <!-- Full Patient Mode -->
            <div id="modeFull" class="hidden">
                <div class="calc-container">
                    <h3 id="fullPatientName">Patient Timeline</h3>
                    <div class="timeline-row">
                        <span class="timeline-label">Transplant Date</span>
                        <input type="date" class="calc-input" id="transplantDate" style="font-size: 1rem; padding: 0.5rem;">
                    </div>
                    
                    <div class="timeline-row">
                        <span class="timeline-label">Baseline FEV‚ÇÅ (L)</span>
                        <input type="number" step="0.01" class="calc-input" id="baselineFev1" 
                               placeholder="Best post-Tx value" style="font-size: 1rem; padding: 0.5rem;">
                    </div>
                    
                    <div id="timelineAnalysis" class="mt-4">
                        <!-- Timeline calculations will be inserted here -->
                    </div>
                </div>
                
                <div class="calc-container">
                    <h3>Current Calculation</h3>
                    <div class="calc-inputs">
                        <div class="input-group">
                            <div class="input-label">FEV‚ÇÅ (L)</div>
                            <input type="number" step="0.01" class="calc-input" id="fullFev1">
                        </div>
                        <div class="input-group">
                            <div class="input-label">FVC (L)</div>
                            <input type="number" step="0.01" class="calc-input" id="fullFvc">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-primary" onclick="calculateFull()">Calculate & Save</button>
                    </div>
                </div>
                
                <div class="results-container" id="fullResults">
                    <!-- Full results will be inserted here -->
                </div>
            </div>
            
            <!-- Review Mode -->
            <div id="modeReview" class="hidden">
                <div class="calc-container">
                    <h3>All Patients Summary</h3>
                    <div id="allPatientsSummary">
                        <!-- Summary will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- New Patient Modal -->
    <div class="modal" id="newPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Patient</h3>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <div class="input-label">Patient ID (PT001, PT002, etc.)</div>
                    <input type="text" class="calc-input" id="newPatientId" 
                           placeholder="PT001" style="font-size: 1rem;">
                </div>
                <div class="input-group mt-4">
                    <div class="input-label">Transplant Date</div>
                    <input type="date" class="calc-input" id="newTransplantDate" style="font-size: 1rem;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="hideModal('newPatientModal')">Cancel</button>
                <button class="btn-primary" onclick="createNewPatient()">Create</button>
            </div>
        </div>
    </div>
    
    <!-- PWA Install Button -->
    <button class="install-btn" id="installButton">üì± Install App</button>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">‚óè Offline Mode</div>

<script>
// ============================================
// NEUMOCALC TIMELINE CALCULATOR
// SINGLE-FILE PWA WITH OFFLINE SUPPORT
// ============================================

// App State
const state = {
    mode: 'quick',
    currentPatient: null,
    patients: new Map(),
    nextPatientId: 1,
    appVersion: '2.0.0'
};

// DOM Elements
const elements = {};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

function initApp() {
    initializeElements();
    loadFromStorage();
    setupPWA();
    setTodayDates();
    updatePatientDisplay();
    updateOnlineStatus();
    
    console.log('üöÄ NeumoCalc v' + state.appVersion + ' loaded');
}

function initializeElements() {
    // Mode containers
    elements.modeQuick = document.getElementById('modeQuick');
    elements.modeFull = document.getElementById('modeFull');
    elements.modeReview = document.getElementById('modeReview');
    
    // Quick mode
    elements.quickFev1 = document.getElementById('quickFev1');
    elements.quickFvc = document.getElementById('quickFvc');
    elements.quickResults = document.getElementById('quickResults');
    elements.patientGrid = document.getElementById('patientGrid');
    
    // Full mode
    elements.transplantDate = document.getElementById('transplantDate');
    elements.baselineFev1 = document.getElementById('baselineFev1');
    elements.fullFev1 = document.getElementById('fullFev1');
    elements.fullFvc = document.getElementById('fullFvc');
    elements.fullResults = document.getElementById('fullResults');
    elements.timelineAnalysis = document.getElementById('timelineAnalysis');
    
    // Patient info
    elements.currentPatientId = document.getElementById('currentPatientId');
    elements.timelineInfo = document.getElementById('timelineInfo');
    
    // Review mode
    elements.allPatientsSummary = document.getElementById('allPatientsSummary');
    
    // Modals
    elements.newPatientModal = document.getElementById('newPatientModal');
    elements.newPatientId = document.getElementById('newPatientId');
    elements.newTransplantDate = document.getElementById('newTransplantDate');
    
    // PWA
    elements.installButton = document.getElementById('installButton');
    elements.offlineIndicator = document.getElementById('offlineIndicator');
}

// ===== PWA OFFLINE SUPPORT =====

function setupPWA() {
    // Register Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(URL.createObjectURL(
            new Blob([`
// Service Worker for NeumoCalc
const CACHE_NAME = 'neumocalc-${state.appVersion}';
const FILES_TO_CACHE = ['/'];

self.addEventListener('install', (e) => {
    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(FILES_TO_CACHE)));
    self.skipWaiting();
});

self.addEventListener('activate', (e) => {
    e.waitUntil(caches.keys().then(keys => 
        Promise.all(keys.map(key => key !== CACHE_NAME && caches.delete(key)))
    ));
    self.clients.claim();
});

self.addEventListener('fetch', (e) => {
    e.respondWith(caches.match(e.request).then(response => response || fetch(e.request)));
});
            `], { type: 'application/javascript' })
        ), { scope: './' }).then(() => {
            console.log('‚úÖ Service Worker registered');
        });
    }
    
    // PWA Install Prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        window.deferredPrompt = e;
        elements.installButton.style.display = 'block';
    });
    
    elements.installButton.addEventListener('click', async () => {
        if (!window.deferredPrompt) return;
        window.deferredPrompt.prompt();
        const { outcome } = await window.deferredPrompt.userChoice;
        console.log(`User ${outcome} the install`);
        elements.installButton.style.display = 'none';
        window.deferredPrompt = null;
    });
    
    // Offline detection
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
}

function updateOnlineStatus() {
    const isOnline = navigator.onLine;
    if (isOnline) {
        elements.offlineIndicator.style.display = 'none';
    } else {
        elements.offlineIndicator.style.display = 'block';
    }
}

// ===== PATIENT MANAGEMENT =====

function generatePatientId() {
    return `PT${state.nextPatientId.toString().padStart(3, '0')}`;
}

function showNewPatientModal() {
    elements.newPatientId.value = generatePatientId();
    elements.newPatientModal.classList.add('show');
}

function hideModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function createNewPatient() {
    const id = elements.newPatientId.value.trim().toUpperCase() || generatePatientId();
    const transplantDate = elements.newTransplantDate.value;
    
    if (!transplantDate) {
        alert('Please enter transplant date');
        return;
    }
    
    const patient = {
        id: id,
        transplantDate: transplantDate,
        baselineFev1: null,
        visits: [],
        created: new Date().toISOString().split('T')[0]
    };
    
    state.patients.set(id, patient);
    state.currentPatient = id;
    state.nextPatientId = Math.max(state.nextPatientId, parseInt(id.substring(2)) + 1);
    
    updatePatientDisplay();
    hideModal('newPatientModal');
    saveToStorage();
    
    // Switch to full mode
    switchMode('full');
    loadPatientData();
}

function selectPatient(patientId) {
    state.currentPatient = patientId;
    updatePatientDisplay();
    
    if (state.mode === 'full') {
        loadPatientData();
    }
}

function updatePatientDisplay() {
    if (state.currentPatient && state.patients.has(state.currentPatient)) {
        const patient = state.patients.get(state.currentPatient);
        elements.currentPatientId.textContent = patient.id;
        
        if (patient.transplantDate) {
            const days = daysBetween(patient.transplantDate, new Date().toISOString().split('T')[0]);
            elements.timelineInfo.textContent = `${days} days post-Tx ‚Ä¢ ${patient.visits.length} visits`;
        }
    } else {
        elements.currentPatientId.textContent = 'No Patient Selected';
        elements.timelineInfo.textContent = '';
    }
    
    updatePatientGrid();
}

function updatePatientGrid() {
    elements.patientGrid.innerHTML = '';
    
    state.patients.forEach((patient, id) => {
        const lastVisit = patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
        
        const card = document.createElement('div');
        card.className = `patient-card ${id === state.currentPatient ? 'active' : ''}`;
        card.innerHTML = `
            <div class="patient-id">${patient.id}</div>
            <div class="patient-stats">${patient.transplantDate || 'No date'}</div>
            <div class="patient-stats">${patient.visits.length} visits</div>
            ${lastVisit ? `<div class="patient-stats">Last: ${lastVisit.fev1.toFixed(2)}L</div>` : ''}
        `;
        card.onclick = () => selectPatient(id);
        elements.patientGrid.appendChild(card);
    });
}

// ===== CALCULATIONS =====

function calculateQuick() {
    const fev1 = parseFloat(elements.quickFev1.value);
    const fvc = parseFloat(elements.quickFvc.value);
    
    if (!fev1 || !fvc) {
        alert('Please enter both FEV‚ÇÅ and FVC values');
        return;
    }
    
    if (!state.currentPatient) {
        alert('Please select a patient first');
        return;
    }
    
    const patient = state.patients.get(state.currentPatient);
    const results = calculateAllValues(fev1, fvc, patient);
    displayResults(results, patient, 'quickResults');
}

function calculateFull() {
    const fev1 = parseFloat(elements.fullFev1.value);
    const fvc = parseFloat(elements.fullFvc.value);
    
    if (!fev1 || !fvc) {
        alert('Please enter both FEV‚ÇÅ and FVC values');
        return;
    }
    
    if (!state.currentPatient) {
        alert('Please select a patient first');
        return;
    }
    
    const patient = state.patients.get(state.currentPatient);
    
    // Update baseline if this is first visit
    if (!patient.baselineFev1) {
        patient.baselineFev1 = fev1;
        elements.baselineFev1.value = fev1;
    }
    
    // Save visit
    patient.visits.push({
        date: new Date().toISOString().split('T')[0],
        fev1: fev1,
        fvc: fvc,
        savedAt: new Date().toISOString()
    });
    
    const results = calculateAllValues(fev1, fvc, patient);
    displayResults(results, patient, 'fullResults');
    
    // Update timeline
    updateTimelineCalculations();
    
    // Save data
    saveToStorage();
    
    alert('‚úì Visit saved successfully');
}

function calculateAllValues(fev1, fvc, patient) {
    const ratio = (fev1 / fvc * 100).toFixed(1);
    const results = {
        measurements: { fev1: fev1.toFixed(2), fvc: fvc.toFixed(2), ratio: ratio }
    };
    
    // Baseline comparison
    if (patient.baselineFev1) {
        const change = ((fev1 - patient.baselineFev1) / patient.baselineFev1 * 100).toFixed(1);
        results.baselineComparison = {
            baseline: patient.baselineFev1.toFixed(2),
            absoluteChange: (fev1 - patient.baselineFev1).toFixed(2),
            percentChange: change
        };
    }
    
    // Last visit comparison
    if (patient.visits.length > 0) {
        const lastVisit = patient.visits[patient.visits.length - 1];
        const daysSinceLast = daysBetween(lastVisit.date, new Date().toISOString().split('T')[0]);
        const changeFromLast = ((fev1 - lastVisit.fev1) / lastVisit.fev1 * 100).toFixed(1);
        const rate = daysSinceLast > 0 ? ((fev1 - lastVisit.fev1) / (daysSinceLast / 30.44)).toFixed(3) : 'N/A';
        
        results.lastVisitComparison = {
            lastValue: lastVisit.fev1.toFixed(2),
            daysSinceLast: daysSinceLast,
            changeFromLast: changeFromLast,
            ratePerMonth: rate
        };
    }
    
    // Timeline
    if (patient.transplantDate) {
        const daysSinceTx = daysBetween(patient.transplantDate, new Date().toISOString().split('T')[0]);
        results.timeline = {
            daysSinceTransplant: daysSinceTx,
            yearsSinceTransplant: (daysSinceTx / 365.25).toFixed(1)
        };
    }
    
    return results;
}

function displayResults(results, patient, containerId) {
    const container = document.getElementById(containerId);
    
    let html = `
        <div class="measurement-card">
            <h4>Current Measurements</h4>
            <div class="timeline-row">
                <span class="timeline-label">FEV‚ÇÅ</span>
                <span class="timeline-value">${results.measurements.fev1} L</span>
            </div>
            <div class="timeline-row">
                <span class="timeline-label">FVC</span>
                <span class="timeline-value">${results.measurements.fvc} L</span>
            </div>
            <div class="timeline-row">
                <span class="timeline-label">FEV‚ÇÅ/FVC</span>
                <span class="timeline-value">${results.measurements.ratio}%</span>
            </div>
        </div>
    `;
    
    // Baseline comparison
    if (results.baselineComparison) {
        const change = parseFloat(results.baselineComparison.percentChange);
        const changeClass = change < 0 ? 'value-negative' : change > 0 ? 'value-positive' : 'value-neutral';
        
        html += `
            <div class="measurement-card">
                <h4>vs Baseline (${results.baselineComparison.baseline} L)</h4>
                <div class="timeline-row">
                    <span class="timeline-label">Œî FEV‚ÇÅ</span>
                    <span class="timeline-value ${changeClass}">${results.baselineComparison.absoluteChange} L</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">% Change</span>
                    <span class="timeline-value ${changeClass}">${results.baselineComparison.percentChange}%</span>
                </div>
            </div>
        `;
    }
    
    // Last visit comparison
    if (results.lastVisitComparison) {
        const change = parseFloat(results.lastVisitComparison.changeFromLast);
        const changeClass = change < 0 ? 'value-negative' : change > 0 ? 'value-positive' : 'value-neutral';
        
        html += `
            <div class="measurement-card">
                <h4>vs Last Visit (${results.lastVisitComparison.lastValue} L)</h4>
                <div class="timeline-row">
                    <span class="timeline-label">Days since last</span>
                    <span class="timeline-value">${results.lastVisitComparison.daysSinceLast}</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">% Change</span>
                    <span class="timeline-value ${changeClass}">${results.lastVisitComparison.changeFromLast}%</span>
                </div>
                <div class="timeline-row">
                    <span class="timeline-label">Rate of change</span>
                    <span class="timeline-value ${changeClass}">${results.lastVisitComparison.ratePerMonth} L/month</span>
                </div>
            </div>
        `;
    }
    
    // Threshold info
    const decline = results.baselineComparison ? Math.abs(parseFloat(results.baselineComparison.percentChange)) : 0;
    let thresholdText = '';
    
    if (decline >= 50) thresholdText = '‚â•50% decline: Consider for urgent BOS evaluation';
    else if (decline >= 35) thresholdText = '‚â•35% decline: Consider for moderate BOS evaluation';
    else if (decline >= 20) thresholdText = '‚â•20% decline: Consider for possible BOS evaluation';
    else if (decline >= 10) thresholdText = '‚â•10% decline: Consider for potential BOS evaluation';
    else thresholdText = '<10% decline: Below threshold for BOS consideration';
    
    html += `
        <div class="threshold-info">
            <h4>ISHLT Reference Thresholds</h4>
            <p><strong>${thresholdText}</strong></p>
            <p style="margin-top: 0.5rem; font-size: 0.875rem;">
                Note: Clinical correlation and sustained decline required for diagnosis.<br>
                This tool provides objective measurements only.
            </p>
        </div>
    `;
    
    container.innerHTML = html;
    container.classList.add('show');
    
    // Scroll to results
    setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
}

function updateTimelineCalculations() {
    if (!state.currentPatient) return;
    
    const patient = state.patients.get(state.currentPatient);
    if (!patient.transplantDate) return;
    
    const today = new Date().toISOString().split('T')[0];
    const daysSinceTx = daysBetween(patient.transplantDate, today);
    
    let html = `
        <div class="timeline-row">
            <span class="timeline-label">Days since transplant</span>
            <span class="timeline-value">${daysSinceTx}</span>
        </div>
        <div class="timeline-row">
            <span class="timeline-label">Years since transplant</span>
            <span class="timeline-value">${(daysSinceTx / 365.25).toFixed(1)}</span>
        </div>
    `;
    
    if (patient.visits.length > 0) {
        const lastVisit = patient.visits[patient.visits.length - 1];
        const daysSinceLast = daysBetween(lastVisit.date, today);
        
        html += `
            <div class="timeline-row">
                <span class="timeline-label">Last visit</span>
                <span class="timeline-value">${formatDate(lastVisit.date)} (${daysSinceLast} days ago)</span>
            </div>
        `;
    }
    
    elements.timelineAnalysis.innerHTML = html;
}

// ===== MODE MANAGEMENT =====

function switchMode(mode) {
    state.mode = mode;
    
    // Update buttons
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(
            mode === 'quick' ? 'Quick' : mode === 'full' ? 'Full' : 'Review'
        ));
    });
    
    // Show/hide modes
    elements.modeQuick.classList.toggle('hidden', mode !== 'quick');
    elements.modeFull.classList.toggle('hidden', mode !== 'full');
    elements.modeReview.classList.toggle('hidden', mode !== 'review');
    
    // Load data
    if (mode === 'full' && state.currentPatient) {
        loadPatientData();
    } else if (mode === 'review') {
        updateReviewMode();
    }
}

function loadPatientData() {
    if (!state.currentPatient) return;
    
    const patient = state.patients.get(state.currentPatient);
    
    if (patient.transplantDate) {
        elements.transplantDate.value = patient.transplantDate;
    }
    
    if (patient.baselineFev1) {
        elements.baselineFev1.value = patient.baselineFev1;
    }
    
    // Copy last values to inputs
    if (patient.visits.length > 0) {
        const last = patient.visits[patient.visits.length - 1];
        elements.fullFev1.value = last.fev1;
        elements.fullFvc.value = last.fvc;
    }
    
    updateTimelineCalculations();
}

function updateReviewMode() {
    let html = '<div class="patient-grid">';
    
    state.patients.forEach(patient => {
        const lastVisit = patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
        
        html += `
            <div class="patient-card" onclick="selectPatient('${patient.id}'); switchMode('full')">
                <div class="patient-id">${patient.id}</div>
                <div class="patient-stats">${patient.transplantDate || 'No date'}</div>
                <div class="patient-stats">${patient.visits.length} visits</div>
                ${lastVisit ? `
                    <div class="patient-stats">Last: ${formatDate(lastVisit.date)}</div>
                    <div class="patient-stats">FEV‚ÇÅ: ${lastVisit.fev1.toFixed(2)}L</div>
                ` : ''}
            </div>
        `;
    });
    
    html += '</div>';
    elements.allPatientsSummary.innerHTML = html;
}

// ===== UTILITIES =====

function daysBetween(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    const diff = Math.abs(d2 - d1);
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
    });
}

function setTodayDates() {
    const today = new Date().toISOString().split('T')[0];
    elements.newTransplantDate.value = today;
    elements.transplantDate.value = today;
    elements.newTransplantDate.max = today;
    elements.transplantDate.max = today;
}

function clearQuickInputs() {
    elements.quickFev1.value = '';
    elements.quickFvc.value = '';
    elements.quickResults.classList.remove('show');
    elements.quickFev1.focus();
}

// ===== STORAGE =====

function saveToStorage() {
    try {
        const data = {
            patients: Array.from(state.patients.entries()),
            nextPatientId: state.nextPatientId,
            currentPatient: state.currentPatient,
            version: state.appVersion,
            savedAt: new Date().toISOString()
        };
        localStorage.setItem('neumocalc', JSON.stringify(data));
    } catch (e) {
        console.warn('Failed to save:', e);
    }
}

function loadFromStorage() {
    try {
        const saved = localStorage.getItem('neumocalc');
        if (saved) {
            const data = JSON.parse(saved);
            
            if (data.patients) {
                state.patients = new Map(data.patients);
            }
            if (data.nextPatientId) {
                state.nextPatientId = data.nextPatientId;
            }
            if (data.currentPatient && state.patients.has(data.currentPatient)) {
                state.currentPatient = data.currentPatient;
            }
            
            console.log('üìÅ Loaded', state.patients.size, 'patients');
        }
    } catch (e) {
        console.warn('Failed to load:', e);
    }
}

// ===== EXPORT =====

function exportAllData() {
    const data = {
        app: 'NeumoCalc',
        version: state.appVersion,
        exportedAt: new Date().toISOString(),
        patients: Object.fromEntries(state.patients),
        settings: { nextPatientId: state.nextPatientId }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `neumocalc-export-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
}

// Add export button
document.addEventListener('DOMContentLoaded', () => {
    const exportBtn = document.createElement('button');
    exportBtn.textContent = 'üíæ Export All';
    exportBtn.className = 'btn-secondary';
    exportBtn.style.cssText = 'position: fixed; bottom: 20px; left: 20px; z-index: 1000;';
    exportBtn.onclick = exportAllData;
    document.body.appendChild(exportBtn);
});

// Initialize
initApp();
</script>
</body>
</html>
